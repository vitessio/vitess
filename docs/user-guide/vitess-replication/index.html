<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/WebPage">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Webfont -->
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!--<link rel="shortcut icon" type="image/png" href="/favicon.png">-->

    <!-- Bootstrap -->
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Styles -->
    <link rel="stylesheet" type="text/css" href="/css/site.css" />
    <!-- Font Awesome icons -->
    <script src="https://use.fontawesome.com/44456bc286.js"></script>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>


    <link rel="icon" href="/images/vitess_logo_icon_size.png" type="image/png">

    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-60219601-1', 'auto');
  ga('send', 'pageview');
</script>

    

    <!-- Metadata *and* <title> Tag generated by SEO Plugin. -->
    <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Vitess and Replication | Vitess</title>
<meta property="og:title" content="Vitess and Replication" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Vitess is a database clustering system for horizontal scaling of MySQL." />
<meta property="og:description" content="Vitess is a database clustering system for horizontal scaling of MySQL." />
<link rel="canonical" href="http://vitess.io/user-guide/vitess-replication/" />
<meta property="og:url" content="http://vitess.io/user-guide/vitess-replication/" />
<meta property="og:site_name" content="Vitess" />
<script type="application/ld+json">
{"name":null,"description":"Vitess is a database clustering system for horizontal scaling of MySQL.","author":null,"@type":"WebPage","url":"http://vitess.io/user-guide/vitess-replication/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://vitess.io/vitess_logo_with_border.svg"}},"image":null,"headline":"Vitess and Replication","dateModified":null,"datePublished":null,"sameAs":null,"mainEntityOfPage":null,"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body class="docs" id="top_of_page">

    <span id="toc-depth" data-toc-depth="h2,h3"></span>


    <nav id="common-nav" class="navbar navbar-fixed-top inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img class="logo" src="/images/vitess_logo_with_border.svg" alt="Vitess">
      </a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right" id="standard-menu-links">
        <li><a href="/overview/">Overview</a></li>
        <li><a href="/user-guide/introduction/">Guides</a></li>
        <li><a href="/reference/vitess-api/">Reference</a></li>
        <li><a href="http://blog.vitess.io">Blog</a></li>
        <li><a href="https://github.com/youtube/vitess"><i class="fa fa-github"></i> GitHub</a></li>
        <!-- Hide link to blog unless we have actual posts -->
        <!-- <li><a href="/blog/" title="">Blog</a></li> -->
      </ul>
      <ul class="nav nav-stacked mobile-left-nav-menu" id="collapsed-left-menu">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/scaling-mysql/">Scaling MySQL with Vitess</a></li>
            <li><a href="/overview/concepts/">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li style="padding-bottom: 0"><a href="/getting-started/">Run Vitess on Kubernetes</a>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/getting-started/docker-build/">Custom Docker Build</a></li>
              </ul>
            </li>
            <li><a href="/getting-started/local-instance/">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction/">Introduction</a>
            <li><a href="/user-guide/backup-and-restore/">Backing Up Data</a>
            <li><a href="/user-guide/reparenting/">Reparenting</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/schema-management/">Schema Management</a></li>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/user-guide/vschema/">VSchema Guide</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/schema-swap/">Schema Swap (Tutorial)</a></li>
              </ul>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding/">Sharding</a>
              <ul style="display: block">
                <li><a href="/user-guide/horizontal-sharding-workflow/">Horizontal Sharding (Tutorial, automated)</a></li>
                <li><a href="/user-guide/horizontal-sharding/">Horizontal Sharding (Tutorial, manual)</a></li>
                <li><a href="/user-guide/sharding-kubernetes-workflow/">Sharding in Kubernetes (Tutorial, automated)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes/">Sharding in Kubernetes (Tutorial, manual)</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/topology-service/">Topology Service</a></li>
            <li><a href="/user-guide/transport-security-model/">Transport Security Model</a></li>
            <h5 class="arrow-r">Launching</h4>
              <ul style="display: block">
                <li><a href="/user-guide/scalability-philosophy/">Scalability Philosophy</a></li>
                <li><a href="/user-guide/production-planning/">Production Planning</a></li>
                <li><a href="/user-guide/server-configuration/">Server Configuration</a></li>
                <li><a href="/user-guide/twopc/">2PC Guide</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/troubleshooting/">Troubleshooting</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/upgrading/">Upgrading</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Advanced Features</h4>
          <ul style="display: none">
            <li><a href="/advanced/">Overview</a>
            <li><a href="/advanced/messaging/">Messaging</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api/">Vitess API</a>
            <li><a href="/reference/vtctl/">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations/">Presentations</a>
            <li><a href="http://blog.vitess.io/">Blog</a>
            <li><a href="/resources/roadmap/">Roadmap</a>
            <li><a href="/resources/design-docs/">Design Docs</a>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/user-guide/vitess-sequences/">Vitess Sequences</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/mysql-server-protocol/">MySQL Server Protocol</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/vitess-replication/">Vitess and Replication</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/update-stream/">Update Stream</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/row-based-replication/">Row Based Replication</a></li>
              </ul>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Contributing</h4>
          <ul style="display: none">
            <li><a href="/contributing/">Contributing to Vitess</a>
            <li><a href="/contributing/github-workflow/">GitHub Workflow</a>
            <li><a href="/contributing/code-reviews/">Code Reviews</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Internal</h4>
          <ul style="display: none">
            <li><a href="/internal/">Overview</a>
            <li><a href="/internal/release-instructions/">Release Instructions</a>
            <li><a href="/internal/publish-website/">Publish Website</a>
          </ul>
        </li>

        <div>
          <form method="get" action="/search/">
            <input id="search-form" name="q" type="text" placeholder="Search">
          </form>
        </div>

        <li><a href="https://github.com/youtube/vitess" id="collapsed-left-menu-repo-link"><i class="fa fa-github"></i> GitHub</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

    
<div id="masthead">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <h1>Vitess and Replication</h1>
      </div>
    </div>
  </div>
</div>


<div class="container">
    <div class="row scroll-margin" id="toc-content-row">
    <div class="col-md-2" id="leftCol">
      <ul class="nav nav-stacked mobile-left-nav-menu" id="sidebar">
                <li class="submenu">
          <h4 class="arrow-r no-top-margin">Overview</h4>
          <ul style="display: none">
            <li><a href="/overview/">What is Vitess</a></li>
            <li><a href="/overview/scaling-mysql/">Scaling MySQL with Vitess</a></li>
            <li><a href="/overview/concepts/">Key Concepts</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Getting Started</h4>
          <ul style="display: none">
            <li style="padding-bottom: 0"><a href="/getting-started/">Run Vitess on Kubernetes</a>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/getting-started/docker-build/">Custom Docker Build</a></li>
              </ul>
            </li>
            <li><a href="/getting-started/local-instance/">Run Vitess Locally</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">User Guide</h4>
          <ul style="display: none">
            <li><a href="/user-guide/introduction/">Introduction</a>
            <li><a href="/user-guide/backup-and-restore/">Backing Up Data</a>
            <li><a href="/user-guide/reparenting/">Reparenting</a></li>
            <li style="padding-bottom: 0"><a href="/user-guide/schema-management/">Schema Management</a></li>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/user-guide/vschema/">VSchema Guide</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/schema-swap/">Schema Swap (Tutorial)</a></li>
              </ul>
            <li style="padding-bottom: 0"><a href="/user-guide/sharding/">Sharding</a>
              <ul style="display: block">
                <li><a href="/user-guide/horizontal-sharding-workflow/">Horizontal Sharding (Tutorial, automated)</a></li>
                <li><a href="/user-guide/horizontal-sharding/">Horizontal Sharding (Tutorial, manual)</a></li>
                <li><a href="/user-guide/sharding-kubernetes-workflow/">Sharding in Kubernetes (Tutorial, automated)</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/sharding-kubernetes/">Sharding in Kubernetes (Tutorial, manual)</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/topology-service/">Topology Service</a></li>
            <li><a href="/user-guide/transport-security-model/">Transport Security Model</a></li>
            <h5 class="arrow-r">Launching</h4>
              <ul style="display: block">
                <li><a href="/user-guide/scalability-philosophy/">Scalability Philosophy</a></li>
                <li><a href="/user-guide/production-planning/">Production Planning</a></li>
                <li><a href="/user-guide/server-configuration/">Server Configuration</a></li>
                <li><a href="/user-guide/twopc/">2PC Guide</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/troubleshooting/">Troubleshooting</a></li>
              </ul>
            </li>
            <li><a href="/user-guide/upgrading/">Upgrading</a></li>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Advanced Features</h4>
          <ul style="display: none">
            <li><a href="/advanced/">Overview</a>
            <li><a href="/advanced/messaging/">Messaging</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Reference Guides</h4>
          <ul style="display: none">
            <li><a href="/reference/vitess-api/">Vitess API</a>
            <li><a href="/reference/vtctl/">vtctl Commands</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Other Resources</h4>
          <ul style="display: none">
            <li><a href="/resources/presentations/">Presentations</a>
            <li><a href="http://blog.vitess.io/">Blog</a>
            <li><a href="/resources/roadmap/">Roadmap</a>
            <li><a href="/resources/design-docs/">Design Docs</a>
              <ul style="display: block">
                <li style="padding-bottom: 0"><a href="/user-guide/vitess-sequences/">Vitess Sequences</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/mysql-server-protocol/">MySQL Server Protocol</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/vitess-replication/">Vitess and Replication</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/update-stream/">Update Stream</a></li>
                <li style="padding-bottom: 0"><a href="/user-guide/row-based-replication/">Row Based Replication</a></li>
              </ul>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Contributing</h4>
          <ul style="display: none">
            <li><a href="/contributing/">Contributing to Vitess</a>
            <li><a href="/contributing/github-workflow/">GitHub Workflow</a>
            <li><a href="/contributing/code-reviews/">Code Reviews</a>
          </ul>
        </li>
        <li class="submenu">
          <h4 class="arrow-r">Internal</h4>
          <ul style="display: none">
            <li><a href="/internal/">Overview</a>
            <li><a href="/internal/release-instructions/">Release Instructions</a>
            <li><a href="/internal/publish-website/">Publish Website</a>
          </ul>
        </li>

        <div>
          <form method="get" action="/search/">
            <input id="search-form" name="q" type="text" placeholder="Search">
          </form>
        </div>

      </ul>
    </div>
    <div class="col-md-3" id="rightCol">
      <div class="nav nav-stacked" id="tocSidebar">
        <div id="toc"></div>
      </div>
    </div>
    <div class="col-md-7" id="centerCol">
      <div id="centerTextCol">
        <h1 id="vitess-mysql-replication-and-schema-changes">Vitess, MySQL Replication, and Schema Changes</h1>

<h2 id="statement-vs-row-based-replication">Statement vs Row Based Replication</h2>

<p>MySQL supports two primary modes of replication in its binary logs: statement or
row based.</p>

<p><strong>Statement Based Replication</strong>:</p>

<ul>
<li>The statements executed on the master are copied almost as-is in the master
logs.</li>
<li>The slaves replay these statements as is.</li>
<li>If the statements are expensive (especially an update with a complicated WHERE
clause), they will be expensive on the slaves too.</li>
<li>For current timestamp and auto-increment values, the master also puts
additional SET statements in the logs to make the statement have the same
effect, so the slaves end up with the same values.</li>
</ul>

<p><strong>Row Based Replication</strong>:</p>

<ul>
<li>The statements executed on the master result in updated rows. The new full
values for these rows are copied to the master logs.</li>
<li>The slaves change their records for the rows they receive. The update is by
primary key, and contains the new values for each column, so usually it’s very
fast.</li>
<li>Each updated row contains the entire row, not just the columns that were
updated (unless the flag --binlog_row_image=minimal is used).</li>
<li>The replication stream is harder to read, as it contains almost binary data,
that don’t easily map to the original statements.</li>
<li>There is a configurable limit on how many rows can be affected by one
binlog event, so the master logs are not flooded.</li>
<li>The format of the logs depends on the master schema: each row has a list of
values, one value for each column. So if the master schema is different from
the slave schema, updates will misbehave (exception being if slave has extra
columns at the end).</li>
<li>It is possible to revert to statement based replication for some commands to
avoid these drawbacks (for instance for DELETE statements that affect a large
number of rows).</li>
<li>Schema changes always use statement based replication.</li>
<li>If comments are added to a statement, they are stripped from the
replication stream (as only rows are transmitted). There is a flag
--binlog_rows_query_log_events to add the original statement to each row
update, but it is costly in terms of binlog size.</li>
</ul>

<p>For the longest time, MySQL replication has been single-threaded: only one
statement is applied by the slaves at a time. Since the master applies more
statements in parallel, replication can fall behind on the slaves fairly easily,
under higher load. Even though the situation has improved (parallel slave
apply), the slave replication speed is still a limiting factor for a lot of
applications. Since row based replication achieves higher update rates on the
slaves in most cases, it has been the only viable option for most performance
sensitive applications.</p>

<p>Schema changes however are not easy to achieve with row based
replication. Adding columns can be done offline, but removing or changing
columns cannot easily be done (there are multiple ways to achieve this, but they
all have limitations or performance implications, and are not that easy to
setup).</p>

<p>Vitess helps by using statement based replication (therefore allowing complex
schema changes), while at the same time simplifying the replication stream (so
slaves can be fast), by rewriting Update statements.</p>

<p>Then, with statement based replication, it becomes easier to perform offline
advanced schema changes, or large data updates. Vitess’s solution is called
schema swap.</p>

<p>We plan to also support row based replication in the future, and adapt our tools
to provide the same features when possible. See Appendix for our plan.</p>

<h2 id="rewriting-update-statements">Rewriting Update Statements</h2>

<p>Vitess rewrites ‘UPDATE’ SQL statements to always know what rows will be
affected. For instance, this statement:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>UPDATE &lt;table&gt; SET &lt;set values&gt; WHERE &lt;clause&gt;
</code></pre></div>
<p>Will be rewritten into:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>SELECT &lt;primary key columns&gt; FROM &lt;table&gt; WHERE &lt;clause&gt; FOR UPDATE
UPDATE &lt;table&gt; SET &lt;set values&gt; WHERE &lt;primary key columns&gt; IN &lt;result from previous SELECT&gt; /* primary key values: … */
</code></pre></div>
<p>With this rewrite in effect, we know exactly which rows are affected, by primary
key, and we also document them as a SQL comment.</p>

<p>The replication stream then doesn’t contain the expensive WHERE clauses, but
only the UPDATE statements by primary key. In a sense, it is combining the best
of row based and statement based replication: the slaves only do primary key
based updates, but the replication stream is very friendly for schema changes.</p>

<p>Also, Vitess adds comments to the rewritten statements that identify the primary
key affected by that statement. This allows us to produce an Update Stream (see
section below).</p>

<h2 id="vitess-schema-swap">Vitess Schema Swap</h2>

<p>Within YouTube, we also use a combination of statement based replication and
backups to apply long-running schema changes without disrupting ongoing
operations. See the <a href="/user-guide/schema-swap/">schema swap tutorial</a>
for a detailed example.</p>

<p>This operation, which is called <strong>schema swap</strong>, works as follows:</p>

<ul>
<li>Pick a slave, take it out of service. It is not used by clients any more.</li>
<li>Apply whatever schema or large data change is needed, on the slave.</li>
<li>Take a backup of that slave.</li>
<li>On all the other slaves, one at a time, take them out of service, restore the
backup, catch up on replication, put them back into service.</li>
<li>When all slaves are done, reparent to a slave that has applied the change.</li>
<li>The old master can then be restored from a backup too, and put back into
service.</li>
</ul>

<p>With this process, the only guarantee we need is for the change (schema or data)
to be backward compatible: the clients won’t know if they talk to a server
that has applied the change yet or not. This is usually fairly easy to deal
with:</p>

<ul>
<li>When adding a column, clients cannot use it until the schema swap is done.</li>
<li>When removing a column, all clients must stop referring to it before the
schema swap begins.</li>
<li>A column rename is still tricky: the best way to do it is to add a new column
with the new name in one schema swap, then change the client to populate both
(and backfill the values), then change the client again to use the new
column only, then use another schema swap to remove the original column.</li>
<li>A whole bunch of operations are really easy to perform though: index changes,
optimize table, …</li>
</ul>

<p>Note the real change is only applied to one instance. We then rely on the backup
/ restore process to propagate the change. This is a very good improvement from
letting the changes through the replication stream, where they are applied to
all hosts, not just one. This is also a very good improvement over the industry
practice of online schema change, which also must run on all hosts.
Since Vitess’s backup / restore and reparent processes
are very reliable (they need to be reliable on their own, independently of this
process!), this does not add much more complexity to a running system.</p>

<h2 id="update-stream">Update Stream</h2>

<p>Since the SBR replication stream also contains comments of which primary key is
affected by a change, it is possible to look at the replication stream and know
exactly what objects have changed. This Vitess feature is
called <a href="/user-guide/update-stream/">Update Stream</a>.</p>

<p>By subscribing to the Update Stream for a given shard, one can know what values
change. This stream can be used to create a stream of data changes (export to an
Apache Kafka for instance), or even invalidate an application layer cache.</p>

<p>Note: the Update Stream only reliably contains the primary key values of the
rows that have changed, not the actual values for all columns. To get these
values, it is necessary to re-query the database.</p>

<p>We have plans to make this <a href="/user-guide/update-stream/">Update Stream</a>
feature more consistent, very resilient, fast, and transparent to sharding.</p>

<h2 id="semi-sync">Semi-Sync</h2>

<p>If you tell Vitess to enforce semi-sync
(<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html">semisynchronous replication</a>)
by passing the <code class="prettyprint">-enable_semi_sync</code> flag to vttablets,
then the following will happen:</p>

<ul>
<li><p>The master will only accept writes if it has at least one slave connected
and sending semi-sync ACK. It will never fall back to asynchronous
(not requiring ACKs) because of timeouts while waiting for ACK, nor because
of having zero slaves connected (although it will fall back to asynchronous
in case of shutdown, abrupt or graceful).</p>

<p>This is important to prevent split brain (or alternate futures) in case of a
network partition. If we can verify all slaves have stopped replicating,
we know the old master is not accepting writes, even if we are unable to
contact the old master itself.</p></li>
<li><p>Slaves of <em>replica</em> type will send semi-sync ACK. Slaves of <em>rdonly</em> type will
<strong>not</strong> send ACK. This is because rdonly slaves are not eligible to be
promoted to master, so we want to avoid the case where a rdonly slave is the
single best candidate for election at the time of master failure (though
a split brain is possible when all rdonly slaves have transactions that
none of replica slaves have).</p></li>
</ul>

<p>These behaviors combine to give you the property that, in case of master
failure, there is at least one other <em>replica</em> type slave that has every
transaction that was ever reported to clients as having completed.
You can then (<a href="/reference/vtctl/#emergencyreparentshard">manually</a>,
or with an automated tool like <a href="https://github.com/github/orchestrator">Orchestrator</a>)
pick the replica that is farthest ahead in GTID position and promote that to be
the new master.</p>

<p>Thus, you can survive sudden master failure without losing any transactions that
were reported to clients as completed. In MySQL 5.7+, this guarantee is
strengthened slightly to preventing loss of any transactions that were ever
<strong>committed</strong> on the original master, eliminating so-called
<a href="http://bugs.mysql.com/bug.php?id=62174">phantom reads</a>.</p>

<p>On the other hand these behaviors also give a requirement that each shard must
have at least 2 tablets with type <em>replica</em> (with addition of the master that
can be demoted to type <em>replica</em> this gives a minimum of 3 tablets with initial
type <em>replica</em>). This will allow for the master to have a semi-sync acker when
one of the <em>replica</em> tablets is down for any reason (for a version update,
machine reboot, schema swap or anything else).</p>

<p>With regard to replication lag, note that this does <strong>not</strong> guarantee there is
always at least one <em>replica</em> type slave from which queries will always return
up-to-date results. Semi-sync guarantees that at least one slave has the
transaction in its relay log, but it has not necessarily been applied yet.
The only way to guarantee a fully up-to-date read is to send the request to the
master.</p>

<h2 id="appendix-adding-support-for-rbr-in-vitess">Appendix: Adding support for RBR in Vitess</h2>

<p>We are in the process of adding support for RBR in Vitess.</p>

<p>See <a href="/user-guide/row-based-replication/">this document</a>) for more information.</p>

      </div>
    </div>
  </div>

</div>

    <div class="page-spacer"></div>
    <footer role="contentinfo" id="site-footer">
  <nav role="navigation" class="menu bottom-menu">
    
    <a href="https://groups.google.com/forum/#!forum/vitess" target="_blank">Contact: vitess@googlegroups.com</a>&nbsp;&nbsp;<b>·</b>&nbsp;&nbsp;
    <a href="https://groups.google.com/forum/#!forum/vitess-announce" target="_blank">Announcements</a>&nbsp;&nbsp;<b>·</b>&nbsp;&nbsp;
    &#169; 2017 <a href="/">Vitess</a> powered by <a href="https://developers.google.com/open-source/">Google Inc</a>
  </nav>
</footer>


        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>   -->
    <!-- Include all compiled plugins (below), or include individual files as needed -->
<!--
    <script src="/libs/bootstrap/js/bootstrap.min.js"></script>
-->
    <!-- Include the common site javascript -->
    <script src="/js/common.js" type="text/javascript" charset="utf-8"></script>


  </body>
</html>

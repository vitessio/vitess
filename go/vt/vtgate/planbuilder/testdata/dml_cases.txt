# update table not found
"update nouser set val = 1"
"table nouser not found"
Gen4 plan same as above

# delete table not found
"delete from nouser"
"table nouser not found"
Gen4 plan same as above

# explicit keyspace reference
"update main.m1 set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update main.m1 set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update m1 set val = 1"
  }
}
Gen4 plan same as above

# update unsharded
"update unsharded set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded set val = 1"
  }
}
Gen4 plan same as above

# subqueries in unsharded update
"update unsharded set col = (select col from unsharded limit 1)"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded set col = (select col from unsharded limit 1)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded set col = (select col from unsharded limit 1)"
  }
}
Gen4 plan same as above

# unsharded union in subquery of unsharded update
"update unsharded set col = (select id from unsharded union select id from unsharded)"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded set col = (select id from unsharded union select id from unsharded)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded set col = (select id from unsharded union select id from unsharded)"
  }
}
Gen4 plan same as above

# unsharded join in subquery of unsharded update
"update unsharded set col = (select id from unsharded a join unsharded b on a.id = b.id)"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded set col = (select id from unsharded a join unsharded b on a.id = b.id)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded set col = (select id from unsharded as a join unsharded as b on a.id = b.id)"
  }
}
Gen4 plan same as above

# update with join subquery
"update unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id set col1 = 'asdf' where keepers.id is null and foo.col is not null and foo.col < 1000"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id set col1 = 'asdf' where keepers.id is null and foo.col is not null and foo.col \u003c 1000",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id set col1 = 'asdf' where keepers.id is null and foo.col is not null and foo.col \u003c 1000"
  }
}
Gen4 plan same as above

# routing rules: updated of a routed table
"update route1 set a=1 where id=1"
{
  "QueryType": "UPDATE",
  "Original": "update route1 set a=1 where id=1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` as route1 set a = 1 where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update: routing rules for subquery.
"update unsharded_a set a=(select a from route2)"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded_a set a=(select a from route2)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded_a set a = (select a from unsharded as route2)"
  }
}
Gen4 plan same as above

# delete unsharded
"delete from unsharded"
{
  "QueryType": "DELETE",
  "Original": "delete from unsharded",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from unsharded"
  }
}
Gen4 plan same as above

# update by primary keyspace id
"update user set val = 1 where id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1 where id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1 where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id with alias
"update user as user_alias set val = 1 where user_alias.id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user as user_alias set val = 1 where user_alias.id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` as user_alias set val = 1 where user_alias.id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id with parenthesized expression
"update user set val = 1 where (id = 1)"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1 where (id = 1)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1 where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id with multi-part where clause with parens
"update user set val = 1 where (name = 'foo' and id = 1)"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1 where (name = 'foo' and id = 1)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1 where `name` = 'foo' and id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id, changing one vindex column
"update user_metadata set email = 'juan@vitess.io' where user_id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user_metadata set email = 'juan@vitess.io' where user_id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "email_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select user_id, email, address, email = 'juan@vitess.io' from user_metadata where user_id = 1 for update",
    "Query": "update user_metadata set email = 'juan@vitess.io' where user_id = 1",
    "Table": "user_metadata",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id, changing same vindex twice
"update user_metadata set email = 'a', email = 'b' where user_id = 1"
"column has duplicate set values: 'email'"
Gen4 plan same as above

# update by primary keyspace id, changing multiple vindex columns
"update user_metadata set email = 'juan@vitess.io', address = '155 5th street' where user_id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user_metadata set email = 'juan@vitess.io', address = '155 5th street' where user_id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "address_user_map:4",
      "email_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select user_id, email, address, email = 'juan@vitess.io', address = '155 5th street' from user_metadata where user_id = 1 for update",
    "Query": "update user_metadata set email = 'juan@vitess.io', address = '155 5th street' where user_id = 1",
    "Table": "user_metadata",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id, changing one vindex column, using order by and limit
"update user_metadata set email = 'juan@vitess.io' where user_id = 1 order by user_id asc limit 10"
{
  "QueryType": "UPDATE",
  "Original": "update user_metadata set email = 'juan@vitess.io' where user_id = 1 order by user_id asc limit 10",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "email_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select user_id, email, address, email = 'juan@vitess.io' from user_metadata where user_id = 1 order by user_id asc limit 10 for update",
    "Query": "update user_metadata set email = 'juan@vitess.io' where user_id = 1 order by user_id asc limit 10",
    "Table": "user_metadata",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id, stray where clause
"update user set val = 1 where id = id2 and id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1 where id = id2 and id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1 where id = id2 and id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update by primary keyspace id, stray where clause with conversion error
"update user set val = 1 where id = 18446744073709551616 and id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1 where id = 18446744073709551616 and id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1 where id = 18446744073709551616 and id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# delete from by primary keyspace id
"delete from user where id = 1"
{
  "QueryType": "DELETE",
  "Original": "delete from user where id = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` where id = 1 for update",
    "Query": "delete from `user` where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# multi-table delete with comma join
"delete a from unsharded_a a, unsharded_b b where a.id = b.id and b.val = 1"
{
  "QueryType": "DELETE",
  "Original": "delete a from unsharded_a a, unsharded_b b where a.id = b.id and b.val = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete a from unsharded_a as a, unsharded_b as b where a.id = b.id and b.val = 1"
  }
}
Gen4 plan same as above

# multi-table delete with ansi join
"delete a from unsharded_a a join unsharded_b b on a.id = b.id where b.val = 1"
{
  "QueryType": "DELETE",
  "Original": "delete a from unsharded_a a join unsharded_b b on a.id = b.id where b.val = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete a from unsharded_a as a join unsharded_b as b on a.id = b.id where b.val = 1"
  }
}
Gen4 plan same as above

#delete with join from subquery
"delete foo from unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id where keepers.id is null and foo.col is not null and foo.col < 1000"
{
  "QueryType": "DELETE",
  "Original": "delete foo from unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id where keepers.id is null and foo.col is not null and foo.col \u003c 1000",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete foo from unsharded as foo left join (select id from unsharded where col is not null order by col desc limit 10) as keepers on foo.id = keepers.id where keepers.id is null and foo.col is not null and foo.col \u003c 1000"
  }
}
Gen4 plan same as above

# routing rules: deleted from a routed table
"delete from route1 where id = 1"
{
  "QueryType": "DELETE",
  "Original": "delete from route1 where id = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` where id = 1 for update",
    "Query": "delete from `user` as route1 where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# delete: routing rules for subquery
"delete from  unsharded_a where a=(select a from route2)"
{
  "QueryType": "DELETE",
  "Original": "delete from  unsharded_a where a=(select a from route2)",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from unsharded_a where a = (select a from unsharded as route2)"
  }
}
Gen4 plan same as above

# update by lookup
"update music set val = 1 where id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update music set val = 1 where id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update music set val = 1 where id = 1",
    "Table": "music",
    "Values": [
      1
    ],
    "Vindex": "music_user_map"
  }
}
Gen4 plan same as above

# update multi-table ansi join
"update unsharded_a a join unsharded_b b on a.id = b.id set a.val = 'foo' where b.val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded_a a join unsharded_b b on a.id = b.id set a.val = 'foo' where b.val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded_a as a join unsharded_b as b on a.id = b.id set a.val = 'foo' where b.val = 1"
  }
}
Gen4 plan same as above

# update multi-table comma join
"update unsharded_a a, unsharded_b b set a.val = 'foo' where a.id = b.id and b.val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded_a a, unsharded_b b set a.val = 'foo' where a.id = b.id and b.val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded_a as a, unsharded_b as b set a.val = 'foo' where a.id = b.id and b.val = 1"
  }
}
Gen4 plan same as above

# delete from by lookup
"delete from music where id = 1"
{
  "QueryType": "DELETE",
  "Original": "delete from music where id = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select user_id, id from music where id = 1 for update",
    "Query": "delete from music where id = 1",
    "Table": "music",
    "Values": [
      1
    ],
    "Vindex": "music_user_map"
  }
}
Gen4 plan same as above

# delete from, no owned vindexes
"delete from music_extra where user_id = 1"
{
  "QueryType": "DELETE",
  "Original": "delete from music_extra where user_id = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from music_extra where user_id = 1",
    "Table": "music_extra",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# simple insert, no values
"insert into unsharded values()"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded values()",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded values ()",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# simple insert unsharded
"insert into unsharded values(1, 2)"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded values(1, 2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded values (1, 2)",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# simple upsert unsharded
"insert into unsharded values(1, 2) on duplicate key update x = 3"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded values(1, 2) on duplicate key update x = 3",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded values (1, 2) on duplicate key update x = 3",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# unsharded insert, no col list with auto-inc and authoritative column list
"insert into unsharded_authoritative values(1,1)"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded_authoritative values(1,1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded_authoritative(col1, col2) values (:__seq0, 1)",
    "TableName": "unsharded_authoritative"
  }
}
Gen4 plan same as above

# sharded upsert with sharding key set to vindex column
"insert into music(user_id, id) values(1, 2) on duplicate key update user_id = values(user_id)"
{
  "QueryType": "INSERT",
  "Original": "insert into music(user_id, id) values(1, 2) on duplicate key update user_id = values(user_id)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "ShardedIgnore",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into music(user_id, id) values (:_user_id_0, :_id_0) on duplicate key update user_id = values(user_id)",
    "TableName": "music"
  }
}
Gen4 plan same as above

# sharded bulk upsert with sharding key set to vindex column
"insert into music(user_id, id) values (1, 2), (3,4) on duplicate key update user_id = values(user_id)"
{
  "QueryType": "INSERT",
  "Original": "insert into music(user_id, id) values (1, 2), (3,4) on duplicate key update user_id = values(user_id)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "ShardedIgnore",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into music(user_id, id) values (:_user_id_0, :_id_0), (:_user_id_1, :_id_1) on duplicate key update user_id = values(user_id)",
    "TableName": "music"
  }
}
Gen4 plan same as above

# insert unsharded with select
"insert into unsharded select id from unsharded_auto"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded select id from unsharded_auto",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded select id from unsharded_auto",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# insert unsharded with select with join
"insert into unsharded select id from unsharded join unsharded_auto"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded select id from unsharded join unsharded_auto",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded select id from unsharded join unsharded_auto",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# insert unsharded, invalid value for auto-inc
"insert into unsharded_auto(id, val) values(18446744073709551616, 'aa')"
"could not compute value for vindex or auto-inc column: strconv.ParseUint: parsing "18446744073709551616": value out of range"
Gen4 plan same as above

# insert unsharded, column present
"insert into unsharded_auto(id, val) values(1, 'aa')"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded_auto(id, val) values(1, 'aa')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded_auto(id, val) values (:__seq0, 'aa')",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# insert unsharded, column absent
"insert into unsharded_auto(val) values('aa')"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded_auto(val) values('aa')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded_auto(val, id) values ('aa', :__seq0)",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# insert unsharded, column absent
"insert into unsharded_auto(val) values(false)"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded_auto(val) values(false)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded_auto(val, id) values (false, :__seq0)",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# insert unsharded, multi-val
"insert into unsharded_auto(id, val) values(1, 'aa'), (null, 'bb')"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded_auto(id, val) values(1, 'aa'), (null, 'bb')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded_auto(id, val) values (:__seq0, 'aa'), (:__seq1, 'bb')",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# unsharded insert subquery in insert value
"insert into unsharded values((select 1 from dual), 1)"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded values((select 1 from dual), 1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded values (1, 1)",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# sharded insert subquery in insert value
"insert into user(id, val) values((select 1), 1)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id, val) values((select 1), 1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, val, `Name`, Costly) values (:_Id_0, 1, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert into a routed table
"insert into route1(id) values (1)"
{
  "QueryType": "INSERT",
  "Original": "insert into route1(id) values (1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with mimatched column list
"insert into user(id) values (1, 2)"
"column list doesn't match values"
Gen4 plan same as above

# insert no column list for sharded authoritative table
"insert into authoritative values(1, 2, 3)"
{
  "QueryType": "INSERT",
  "Original": "insert into authoritative values(1, 2, 3)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into authoritative(user_id, col1, col2) values (:_user_id_0, 2, 3)",
    "TableName": "authoritative"
  }
}
Gen4 plan same as above

# insert sharded, no values
"insert into user values()"
{
  "QueryType": "INSERT",
  "Original": "insert into user values()",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with one vindex
"insert into user(id) values (1)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id) values (1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert ignore sharded
"insert ignore into user(id) values (1)"
{
  "QueryType": "INSERT",
  "Original": "insert ignore into user(id) values (1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "ShardedIgnore",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert ignore into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert on duplicate key
"insert into user(id) values(1) on duplicate key update col = 2"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id) values(1) on duplicate key update col = 2",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "ShardedIgnore",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0) on duplicate key update col = 2",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with one vindex and bind var
"insert into user(id) values (:aa)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id) values (:aa)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with non vindex
"insert into user(nonid) values (2)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(nonid) values (2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(nonid, id, `Name`, Costly) values (2, :_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with default seq
"insert into user(id, nonid) values (default, 2)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id, nonid) values (default, 2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, nonid, `Name`, Costly) values (:_Id_0, 2, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with non vindex bool value
"insert into user(nonid) values (true)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(nonid) values (true)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(nonid, id, `Name`, Costly) values (true, :_Id_0, :_Name_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with all vindexes supplied
"insert into user(nonid, name, id) values (2, 'foo', 1)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(nonid, name, id) values (2, 'foo', 1)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(nonid, `name`, id, Costly) values (2, :_Name_0, :_Id_0, :_Costly_0)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert for non-vindex autoinc
"insert into user_extra(nonid) values (2)"
{
  "QueryType": "INSERT",
  "Original": "insert into user_extra(nonid) values (2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into user_extra(nonid, extra_id, user_id) values (2, :__seq0, :_user_id_0)",
    "TableName": "user_extra"
  }
}
Gen4 plan same as above

# insert for non-compliant names
"insert into `weird``name`(`a``b*c`, `b*c`) values(1, 2)"
{
  "QueryType": "INSERT",
  "Original": "insert into `weird``name`(`a``b*c`, `b*c`) values(1, 2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `weird``name`(`a``b*c`, `b*c`) values (:_a_b_c_0, 2)",
    "TableName": "weird`name"
  }
}
Gen4 plan same as above

# unsharded insert from union
"insert into unsharded select 1 from dual union select 1 from dual"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded select 1 from dual union select 1 from dual",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded select 1 from dual union select 1 from dual",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# insert for non-vindex autoinc, invalid value
"insert into user_extra(nonid, extra_id) values (2, 18446744073709551616)"
"could not compute value for vindex or auto-inc column: strconv.ParseUint: parsing "18446744073709551616": value out of range"
Gen4 plan same as above

# insert invalid index value
"insert into music_extra(music_id, user_id) values(1, 18446744073709551616)"
"could not compute value for vindex or auto-inc column: strconv.ParseUint: parsing "18446744073709551616": value out of range"
Gen4 plan same as above

# insert invalid index value
"insert into music_extra(music_id, user_id) values(1, id)"
"could not compute value for vindex or auto-inc column: expression is too complex 'id'"
Gen4 plan same as above

# insert invalid table
"insert into noexist(music_id, user_id) values(1, 18446744073709551616)"
"table noexist not found"
Gen4 plan same as above

# insert with multiple rows
"insert into user(id) values (1), (2)"
{
  "QueryType": "INSERT",
  "Original": "insert into user(id) values (1), (2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0), (:_Id_1, :_Name_1, :_Costly_1)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with query timeout
"insert /*vt+ QUERY_TIMEOUT_MS=1 */ into user(id) values (1), (2)"
{
  "QueryType": "INSERT",
  "Original": "insert /*vt+ QUERY_TIMEOUT_MS=1 */ into user(id) values (1), (2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert /*vt+ QUERY_TIMEOUT_MS=1 */ into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0), (:_Id_1, :_Name_1, :_Costly_1)",
    "QueryTimeout": 1,
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert with multiple rows - multi-shard autocommit
"insert /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ into user(id) values (1), (2)"
{
  "QueryType": "INSERT",
  "Original": "insert /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ into user(id) values (1), (2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": true,
    "Query": "insert /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ into `user`(id, `Name`, Costly) values (:_Id_0, :_Name_0, :_Costly_0), (:_Id_1, :_Name_1, :_Costly_1)",
    "TableName": "user"
  }
}
Gen4 plan same as above

# insert into a vindex not allowed
"insert into user_index(id) values(1)"
"unsupported: multi-shard or vindex write statement"
Gen4 plan same as above

# simple replace unsharded
"replace into unsharded values(1, 2)"
{
  "QueryType": "INSERT",
  "Original": "replace into unsharded values(1, 2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "replace into unsharded values (1, 2)",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# replace unsharded with select
"replace into unsharded select id from unsharded_auto"
{
  "QueryType": "INSERT",
  "Original": "replace into unsharded select id from unsharded_auto",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "replace into unsharded select id from unsharded_auto",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# replace unsharded, invalid value for auto-inc
"replace into unsharded_auto(id, val) values(18446744073709551616, 'aa')"
"could not compute value for vindex or auto-inc column: strconv.ParseUint: parsing "18446744073709551616": value out of range"
Gen4 plan same as above

# replace unsharded, column present
"replace into unsharded_auto(id, val) values(1, 'aa')"
{
  "QueryType": "INSERT",
  "Original": "replace into unsharded_auto(id, val) values(1, 'aa')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "replace into unsharded_auto(id, val) values (:__seq0, 'aa')",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# replace unsharded, column absent
"replace into unsharded_auto(val) values('aa')"
{
  "QueryType": "INSERT",
  "Original": "replace into unsharded_auto(val) values('aa')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "replace into unsharded_auto(val, id) values ('aa', :__seq0)",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# replace unsharded, multi-val
"replace into unsharded_auto(id, val) values(1, 'aa'), (null, 'bb')"
{
  "QueryType": "INSERT",
  "Original": "replace into unsharded_auto(id, val) values(1, 'aa'), (null, 'bb')",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "replace into unsharded_auto(id, val) values (:__seq0, 'aa'), (:__seq1, 'bb')",
    "TableName": "unsharded_auto"
  }
}
Gen4 plan same as above

# replace invalid table
"replace into noexist(music_id, user_id) values(1, 18446744073709551616)"
"table noexist not found"
Gen4 plan same as above

# insert a row in a multi column vindex table
"insert multicolvin (column_a, column_b, column_c, kid) VALUES (1,2,3,4)"
{
  "QueryType": "INSERT",
  "Original": "insert multicolvin (column_a, column_b, column_c, kid) VALUES (1,2,3,4)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into multicolvin(column_a, column_b, column_c, kid) values (:_column_a_0, :_column_b_0, :_column_c_0, :_kid_0)",
    "TableName": "multicolvin"
  }
}
Gen4 plan same as above

# insert for overlapped vindex columns
"insert overlap_vindex (kid, column_a, column_b) VALUES (1,2,3)"
{
  "QueryType": "INSERT",
  "Original": "insert overlap_vindex (kid, column_a, column_b) VALUES (1,2,3)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into overlap_vindex(kid, column_a, column_b) values (:_kid_0, :_column_a_0, 3)",
    "TableName": "overlap_vindex"
  }
}
Gen4 plan same as above

# insert multiple rows in a multi column vindex table
"insert multicolvin (column_a, column_b, column_c, kid) VALUES (1,2,3,4), (5,6,7,8)"
{
  "QueryType": "INSERT",
  "Original": "insert multicolvin (column_a, column_b, column_c, kid) VALUES (1,2,3,4), (5,6,7,8)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Sharded",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into multicolvin(column_a, column_b, column_c, kid) values (:_column_a_0, :_column_b_0, :_column_c_0, :_kid_0), (:_column_a_1, :_column_b_1, :_column_c_1, :_kid_1)",
    "TableName": "multicolvin"
  }
}
Gen4 plan same as above

# delete row in a multi column vindex table
"delete from multicolvin where kid=1"
{
  "QueryType": "DELETE",
  "Original": "delete from multicolvin where kid=1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "kid_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select kid, column_a, column_b, column_c from multicolvin where kid = 1 for update",
    "Query": "delete from multicolvin where kid = 1",
    "Table": "multicolvin",
    "Values": [
      1
    ],
    "Vindex": "kid_index"
  }
}
Gen4 plan same as above

# update columns of multi column vindex
"update multicolvin set column_b = 1, column_c = 2 where kid = 1"
{
  "QueryType": "UPDATE",
  "Original": "update multicolvin set column_b = 1, column_c = 2 where kid = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "colb_colc_map:4"
    ],
    "KsidVindex": "kid_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select kid, column_a, column_b, column_c, column_b = 1 and column_c = 2 from multicolvin where kid = 1 for update",
    "Query": "update multicolvin set column_b = 1, column_c = 2 where kid = 1",
    "Table": "multicolvin",
    "Values": [
      1
    ],
    "Vindex": "kid_index"
  }
}
Gen4 plan same as above

# update multiple vindexes, with multi column vindex
"update multicolvin set column_a = 0, column_b = 1, column_c = 2 where kid = 1"
{
  "QueryType": "UPDATE",
  "Original": "update multicolvin set column_a = 0, column_b = 1, column_c = 2 where kid = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "cola_map:4",
      "colb_colc_map:5"
    ],
    "KsidVindex": "kid_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select kid, column_a, column_b, column_c, column_a = 0, column_b = 1 and column_c = 2 from multicolvin where kid = 1 for update",
    "Query": "update multicolvin set column_a = 0, column_b = 1, column_c = 2 where kid = 1",
    "Table": "multicolvin",
    "Values": [
      1
    ],
    "Vindex": "kid_index"
  }
}
Gen4 plan same as above

# update with no primary vindex on where clause (scatter update)
"update user_extra set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with target destination
"update `user[-]`.user_extra set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update `user[-]`.user_extra set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "ByDestination",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with no primary vindex on where clause (scatter update)   - multi shard autocommit
"update /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */  user_extra set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */  user_extra set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": true,
    "Query": "update /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ user_extra set val = 1",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with no primary vindex on where clause (scatter update)   - query timeout
"update /*vt+ QUERY_TIMEOUT_MS=1 */  user_extra set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update /*vt+ QUERY_TIMEOUT_MS=1 */  user_extra set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update /*vt+ QUERY_TIMEOUT_MS=1 */ user_extra set val = 1",
    "QueryTimeout": 1,
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with non-comparison expr
"update user_extra set val = 1 where id between 1 and 2"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1 where id between 1 and 2",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1 where id between 1 and 2",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with primary id through IN clause
"update user_extra set val = 1 where user_id in (1, 2)"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1 where user_id in (1, 2)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "In",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1 where user_id in (1, 2)",
    "Table": "user_extra",
    "Values": [
      [
        1,
        2
      ]
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update with non-unique key
"update user_extra set val = 1 where name = 'foo'"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1 where name = 'foo'",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1 where `name` = 'foo'",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update by lookup with IN clause
"update user_extra set val = 1 where id in (1, 2)"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1 where id in (1, 2)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1 where id in (1, 2)",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# update with where clause with parens
"update user_extra set val = 1 where (name = 'foo' or id = 1)"
{
  "QueryType": "UPDATE",
  "Original": "update user_extra set val = 1 where (name = 'foo' or id = 1)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1 where `name` = 'foo' or id = 1",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete from with no where clause
"delete from user_extra"
{
  "QueryType": "DELETE",
  "Original": "delete from user_extra",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from user_extra",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete with target destination
"delete from `user[-]`.user_extra"
{
  "QueryType": "DELETE",
  "Original": "delete from `user[-]`.user_extra",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "ByDestination",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from user_extra",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete with non-comparison expr
"delete from user_extra where user_id between 1 and 2"
{
  "QueryType": "DELETE",
  "Original": "delete from user_extra where user_id between 1 and 2",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from user_extra where user_id between 1 and 2",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete from with no index match
"delete from user_extra where name = 'jose'"
{
  "QueryType": "DELETE",
  "Original": "delete from user_extra where name = 'jose'",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from user_extra where `name` = 'jose'",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete from with no index match - multi shard autocommit
"delete /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ from user_extra where name = 'jose'"
{
  "QueryType": "DELETE",
  "Original": "delete /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ from user_extra where name = 'jose'",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": true,
    "Query": "delete /*vt+ MULTI_SHARD_AUTOCOMMIT=1 */ from user_extra where `name` = 'jose'",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete from with no index match - query timeout
"delete /*vt+ QUERY_TIMEOUT_MS=1 */ from user_extra where name = 'jose'"
{
  "QueryType": "DELETE",
  "Original": "delete /*vt+ QUERY_TIMEOUT_MS=1 */ from user_extra where name = 'jose'",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete /*vt+ QUERY_TIMEOUT_MS=1 */ from user_extra where `name` = 'jose'",
    "QueryTimeout": 1,
    "Table": "user_extra"
  }
}
Gen4 plan same as above

# delete from with primary id in through IN clause
"delete from user_extra where user_id in (1, 2)"
{
  "QueryType": "DELETE",
  "Original": "delete from user_extra where user_id in (1, 2)",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "In",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from user_extra where user_id in (1, 2)",
    "Table": "user_extra",
    "Values": [
      [
        1,
        2
      ]
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# unsharded update where inner query references outer query
"update unsharded set col = (select id from unsharded_a where id = unsharded.col) where col = (select id from unsharded_b)"
{
  "QueryType": "UPDATE",
  "Original": "update unsharded set col = (select id from unsharded_a where id = unsharded.col) where col = (select id from unsharded_b)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update unsharded set col = (select id from unsharded_a where id = unsharded.col) where col = (select id from unsharded_b)"
  }
}
Gen4 plan same as above

# unsharded delete where inner query references outer query
"delete from unsharded where col = (select id from unsharded_a where id = unsharded.col)"
{
  "QueryType": "DELETE",
  "Original": "delete from unsharded where col = (select id from unsharded_a where id = unsharded.col)",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "delete from unsharded where col = (select id from unsharded_a where id = unsharded.col)"
  }
}
Gen4 plan same as above

# update vindex value to null
"update user set name = null where id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set name = null where id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = null from `user` where id = 1 for update",
    "Query": "update `user` set `name` = null where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# insert using last_insert_id
"insert into unsharded values(last_insert_id(), 2)"
{
  "QueryType": "INSERT",
  "Original": "insert into unsharded values(last_insert_id(), 2)",
  "Instructions": {
    "OperatorType": "Insert",
    "Variant": "Unsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "insert into unsharded values (:__lastInsertId, 2)",
    "TableName": "unsharded"
  }
}
Gen4 plan same as above

# update vindex value to null with multiple primary keyspace id
"update user set name = null where id in (1, 2, 3)"
{
  "QueryType": "UPDATE",
  "Original": "update user set name = null where id in (1, 2, 3)",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "In",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = null from `user` where id in (1, 2, 3) for update",
    "Query": "update `user` set `name` = null where id in (1, 2, 3)",
    "Table": "user",
    "Values": [
      [
        1,
        2,
        3
      ]
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# update vindex value to null without a where clause
"update user set name = null"
{
  "QueryType": "UPDATE",
  "Original": "update user set name = null",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = null from `user` for update",
    "Query": "update `user` set `name` = null",
    "Table": "user"
  }
}
Gen4 plan same as above

# update vindex value to null with complex where clause
"update user set name = null where id + 1 = 2"
{
  "QueryType": "UPDATE",
  "Original": "update user set name = null where id + 1 = 2",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = null from `user` where id + 1 = 2 for update",
    "Query": "update `user` set `name` = null where id + 1 = 2",
    "Table": "user"
  }
}
Gen4 plan same as above

# delete from user by primary keyspace id with in clause
"delete from user where id in (1, 2, 3)"
{
  "QueryType": "DELETE",
  "Original": "delete from user where id in (1, 2, 3)",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "In",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` where id in (1, 2, 3) for update",
    "Query": "delete from `user` where id in (1, 2, 3)",
    "Table": "user",
    "Values": [
      [
        1,
        2,
        3
      ]
    ],
    "Vindex": "user_index"
  }
}
Gen4 plan same as above

# delete from user by complex expression
"delete from user where id + 1 = 2"
{
  "QueryType": "DELETE",
  "Original": "delete from user where id + 1 = 2",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` where id + 1 = 2 for update",
    "Query": "delete from `user` where id + 1 = 2",
    "Table": "user"
  }
}
Gen4 plan same as above

# delete from user without a where clause
"delete from user"
{
  "QueryType": "DELETE",
  "Original": "delete from user",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` for update",
    "Query": "delete from `user`",
    "Table": "user"
  }
}
Gen4 plan same as above

# delete with single table targets
"delete music from music where id = 1"
{
  "QueryType": "DELETE",
  "Original": "delete music from music where id = 1",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select user_id, id from music where id = 1 for update",
    "Query": "delete music from music where id = 1",
    "Table": "music",
    "Values": [
      1
    ],
    "Vindex": "music_user_map"
  }
}
Gen4 plan same as above

# scatter update table with owned vindexes without changing lookup vindex
"update user set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update `user` set val = 1",
    "Table": "user"
  }
}
Gen4 plan same as above

# scatter delete with owned lookup vindex
"delete from user"
{
  "QueryType": "DELETE",
  "Original": "delete from user",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` for update",
    "Query": "delete from `user`",
    "Table": "user"
  }
}
Gen4 plan same as above

# update multi column vindex, without values for all the vindex columns
"update multicolvin set column_c = 2 where kid = 1"
{
  "QueryType": "UPDATE",
  "Original": "update multicolvin set column_c = 2 where kid = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "colb_colc_map:4"
    ],
    "KsidVindex": "kid_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select kid, column_a, column_b, column_c, column_c = 2 from multicolvin where kid = 1 for update",
    "Query": "update multicolvin set column_c = 2 where kid = 1",
    "Table": "multicolvin",
    "Values": [
      1
    ],
    "Vindex": "kid_index"
  }
}
Gen4 plan same as above

# update with binary value
"update user set name = _binary 'abc' where id = 1"
{
  "QueryType": "UPDATE",
  "Original": "update user set name = _binary 'abc' where id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = _binary 'abc' from `user` where id = 1 for update",
    "Query": "update `user` set `name` = _binary 'abc' where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}
{
  "QueryType": "UPDATE",
  "Original": "update user set name = _binary 'abc' where id = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "Equal",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = _binary 'abc' from `user` where id = 1 for update",
    "Query": "update `user` set `name` = _binary 'abc' where id = 1",
    "Table": "user",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}

# delete with binary value
"delete from user where name = _binary 'abc'"
{
  "QueryType": "DELETE",
  "Original": "delete from user where name = _binary 'abc'",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "Scatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` where `name` = _binary 'abc' for update",
    "Query": "delete from `user` where `name` = _binary 'abc'",
    "Table": "user"
  }
}
Gen4 plan same as above

# delete with shard targeting
"delete from `user[-]`.user"
{
  "QueryType": "DELETE",
  "Original": "delete from `user[-]`.user",
  "Instructions": {
    "OperatorType": "Delete",
    "Variant": "ByDestination",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly from `user` for update",
    "Query": "delete from `user`",
    "Table": "user"
  }
}
Gen4 plan same as above

# update with shard targeting
"update `user[-]`.user set name = 'myname'"
{
  "QueryType": "UPDATE",
  "Original": "update `user[-]`.user set name = 'myname'",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "ByDestination",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "ChangedVindexValues": [
      "name_user_map:3"
    ],
    "KsidVindex": "user_index",
    "MultiShardAutocommit": false,
    "OwnedVindexQuery": "select Id, `Name`, Costly, `name` = 'myname' from `user` for update",
    "Query": "update `user` set `name` = 'myname'",
    "Table": "user"
  }
}
Gen4 plan same as above

# update with shard targeting without vindex
"update `user[-]`.user_extra set val = 1"
{
  "QueryType": "UPDATE",
  "Original": "update `user[-]`.user_extra set val = 1",
  "Instructions": {
    "OperatorType": "Update",
    "Variant": "ByDestination",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "TargetTabletType": "MASTER",
    "MultiShardAutocommit": false,
    "Query": "update user_extra set val = 1",
    "Table": "user_extra"
  }
}
Gen4 plan same as above

[
  {
    "comment": "Insertion in a table with cross-shard foreign keys disallowed",
    "query": "insert into tbl3 (col3, coly) values (1, 3)",
    "plan": "VT12002: unsupported: cross-shard foreign keys"
  },
  {
    "comment": "Insertion in a table with shard-scoped foreign keys is allowed",
    "query": "insert into tbl2 (col2, coly) values (1, 3)",
    "plan": {
      "QueryType": "INSERT",
      "Original": "insert into tbl2 (col2, coly) values (1, 3)",
      "Instructions": {
        "OperatorType": "Insert",
        "Variant": "Sharded",
        "Keyspace": {
          "Name": "sharded_fk_allow",
          "Sharded": true
        },
        "TargetTabletType": "PRIMARY",
        "Query": "insert into tbl2(col2, coly) values (:_col2_0, 3)",
        "TableName": "tbl2",
        "VindexValues": {
          "hash_vin": "INT64(1)"
        }
      },
      "TablesUsed": [
        "sharded_fk_allow.tbl2"
      ]
    }
  },
  {
    "comment": "Insertion in a table with shard-scoped multiple column foreign key is allowed",
    "query": "insert into multicol_tbl2 (cola, colb, colc) values (1, 2, 3)",
    "plan": {
      "QueryType": "INSERT",
      "Original": "insert into multicol_tbl2 (cola, colb, colc) values (1, 2, 3)",
      "Instructions": {
        "OperatorType": "Insert",
        "Variant": "Sharded",
        "Keyspace": {
          "Name": "sharded_fk_allow",
          "Sharded": true
        },
        "TargetTabletType": "PRIMARY",
        "Query": "insert into multicol_tbl2(cola, colb, colc) values (:_cola_0, :_colb_0, :_colc_0)",
        "TableName": "multicol_tbl2",
        "VindexValues": {
          "multicolIdx": "INT64(1), INT64(2), INT64(3)"
        }
      },
      "TablesUsed": [
        "sharded_fk_allow.multicol_tbl2"
      ]
    }
  },
  {
    "comment": "Delete in a table with cross-shard foreign keys disallowed",
    "query": "delete from tbl1",
    "plan": "VT12002: unsupported: cross-shard foreign keys"
  },
  {
    "comment": "Delete in a table with not all column shard-scoped foreign keys - disallowed",
    "query": "delete from tbl7",
    "plan": "VT12002: unsupported: cross-shard foreign keys"
  },
  {
    "comment": "Delete in a table with shard-scoped multiple column foreign key with cascade",
    "query": "delete from multicol_tbl1 where cola = 1 and  colb = 2 and colc = 3",
    "plan": {
      "QueryType": "DELETE",
      "Original": "delete from multicol_tbl1 where cola = 1 and  colb = 2 and colc = 3",
      "Instructions": {
        "OperatorType": "FkCascade",
        "Children": [
          {
            "OperatorType": "FkCascadeChild",
            "BvName": "fkc_vals",
            "Cols": [
              0,
              1,
              2,
              3,
              4
            ],
            "Inputs": [
              {
                "OperatorType": "Delete",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "sharded_fk_allow",
                  "Sharded": true
                },
                "TargetTabletType": "PRIMARY",
                "Query": "delete from multicol_tbl2 where (colb, cola, x, colc, y) in ::fkc_vals",
                "Table": "multicol_tbl2"
              }
            ]
          }
        ],
        "Parent": {
          "OperatorType": "Delete",
          "Variant": "EqualUnique",
          "Keyspace": {
            "Name": "sharded_fk_allow",
            "Sharded": true
          },
          "TargetTabletType": "PRIMARY",
          "Query": "delete from multicol_tbl1 where cola = 1 and colb = 2 and colc = 3",
          "Table": "multicol_tbl1",
          "Values": [
            "INT64(1)",
            "INT64(2)",
            "INT64(3)"
          ],
          "Vindex": "multicolIdx"
        },
        "Selection": {
          "OperatorType": "Route",
          "Variant": "EqualUnique",
          "Keyspace": {
            "Name": "sharded_fk_allow",
            "Sharded": true
          },
          "FieldQuery": "select colb, cola, y, colc, x from multicol_tbl1 where 1 != 1",
          "Query": "select colb, cola, y, colc, x from multicol_tbl1 where cola = 1 and colb = 2 and colc = 3 lock in share mode",
          "Table": "multicol_tbl1",
          "Values": [
            "INT64(1)",
            "INT64(2)",
            "INT64(3)"
          ],
          "Vindex": "multicolIdx"
        }
      },
      "TablesUsed": [
        "sharded_fk_allow.multicol_tbl1",
        "sharded_fk_allow.multicol_tbl2"
      ]
    }
  },
  {
    "comment": "Delete in a table with shard-scoped foreign keys with cascade",
    "query": "delete from tbl5",
    "plan": {
      "QueryType": "DELETE",
      "Original": "delete from tbl5",
      "Instructions": {
        "OperatorType": "FkCascade",
        "Children": [
          {
            "OperatorType": "FkCascadeChild",
            "BvName": "fkc_vals",
            "Cols": [
              0
            ],
            "Inputs": [
              {
                "OperatorType": "Delete",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "sharded_fk_allow",
                  "Sharded": true
                },
                "TargetTabletType": "PRIMARY",
                "Query": "delete from tbl4 where (col4) in ::fkc_vals",
                "Table": "tbl4"
              }
            ]
          },
          {
            "OperatorType": "FkCascadeChild",
            "BvName": "fkc_vals1",
            "Cols": [
              1
            ],
            "Inputs": [
              {
                "OperatorType": "Delete",
                "Variant": "Scatter",
                "Keyspace": {
                  "Name": "sharded_fk_allow",
                  "Sharded": true
                },
                "TargetTabletType": "PRIMARY",
                "Query": "delete from tbl4 where (t4col4) in ::fkc_vals1",
                "Table": "tbl4"
              }
            ]
          }
        ],
        "Parent": {
          "OperatorType": "Delete",
          "Variant": "Scatter",
          "Keyspace": {
            "Name": "sharded_fk_allow",
            "Sharded": true
          },
          "TargetTabletType": "PRIMARY",
          "Query": "delete from tbl5",
          "Table": "tbl5"
        },
        "Selection": {
          "OperatorType": "Route",
          "Variant": "Scatter",
          "Keyspace": {
            "Name": "sharded_fk_allow",
            "Sharded": true
          },
          "FieldQuery": "select col5, t5col5 from tbl5 where 1 != 1",
          "Query": "select col5, t5col5 from tbl5 lock in share mode",
          "Table": "tbl5"
        }
      },
      "TablesUsed": [
        "sharded_fk_allow.tbl4",
        "sharded_fk_allow.tbl5"
      ]
    }
  },
  {
    "comment": "Delete in a table with shard-scoped foreign keys with SET NULL",
    "query": "delete from tbl8 where col8 = 1",
    "plan": "VT12001: unsupported: you cannot UPDATE primary vindex columns; invalid update on vindex: hash_vin"
  },
  {
    "comment": "Delete in a table with unsharded foreign key with SET NULL",
    "query": "delete from u_tbl9 where col9 = 5",
    "plan": {
      "QueryType": "DELETE",
      "Original": "delete from u_tbl9 where col9 = 5",
      "Instructions": {
        "OperatorType": "FkCascade",
        "Children": [
          {
            "OperatorType": "FkCascadeChild",
            "BvName": "fkc_vals",
            "Cols": [
              0
            ],
            "Inputs": [
              {
                "OperatorType": "Update",
                "Variant": "Unsharded",
                "Keyspace": {
                  "Name": "unsharded_fk_allow",
                  "Sharded": false
                },
                "TargetTabletType": "PRIMARY",
                "Query": "update u_tbl8 set col8 = null where (col8) in ::fkc_vals",
                "Table": "u_tbl8"
              }
            ]
          }
        ],
        "Parent": {
          "OperatorType": "Delete",
          "Variant": "Unsharded",
          "Keyspace": {
            "Name": "unsharded_fk_allow",
            "Sharded": false
          },
          "TargetTabletType": "PRIMARY",
          "Query": "delete from u_tbl9 where col9 = 5",
          "Table": "u_tbl9"
        },
        "Selection": {
          "OperatorType": "Route",
          "Variant": "Unsharded",
          "Keyspace": {
            "Name": "unsharded_fk_allow",
            "Sharded": false
          },
          "FieldQuery": "select col9 from u_tbl9 where 1 != 1",
          "Query": "select col9 from u_tbl9 where col9 = 5 lock in share mode",
          "Table": "u_tbl9"
        }
      },
      "TablesUsed": [
        "unsharded_fk_allow.u_tbl8",
        "unsharded_fk_allow.u_tbl9"
      ]
    }
  },
  {
    "comment": "update in unsharded table with restrict",
    "query": "update u_tbl5 set col5 = 'foo' where id = 1",
    "plan": {
      "QueryType": "UPDATE",
      "Original": "update u_tbl5 set col5 = 'foo' where id = 1",
      "Instructions": {
        "OperatorType": "Update",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "unsharded_fk_allow",
          "Sharded": false
        },
        "TargetTabletType": "PRIMARY",
        "Query": "update u_tbl5 set col5 = 'foo' where id = 1",
        "Table": "u_tbl5"
      },
      "TablesUsed": [
        "unsharded_fk_allow.u_tbl5"
      ]
    }
  },
  {
    "comment": "update in unsharded table with cascade",
    "query": "update u_tbl2 set col2 = 'bar' where id = 1",
    "plan": "VT12002: unsupported: foreign keys management at vitess"
  },
  {
    "comment": "update in unsharded table with cascade - on non-referenced column",
    "query": "update u_tbl2 set col_no_ref = 'baz' where id = 1",
    "plan": {
      "QueryType": "UPDATE",
      "Original": "update u_tbl2 set col_no_ref = 'baz' where id = 1",
      "Instructions": {
        "OperatorType": "Update",
        "Variant": "Unsharded",
        "Keyspace": {
          "Name": "unsharded_fk_allow",
          "Sharded": false
        },
        "TargetTabletType": "PRIMARY",
        "Query": "update u_tbl2 set col_no_ref = 'baz' where id = 1",
        "Table": "u_tbl2"
      },
      "TablesUsed": [
        "unsharded_fk_allow.u_tbl2"
      ]
    }
  },
  {
    "comment": "Update in a table with cross-shard foreign keys disallowed",
    "query": "update tbl1 set t1col1 = 'foo' where col1 = 1",
    "plan": "VT12002: unsupported: foreign keys management at vitess"
  },
  {
    "comment": "Update in a table with cross-shard foreign keys, column not in update expression - allowed",
    "query": "update tbl1 set not_ref_col = 'foo' where id = 1",
    "plan": {
      "QueryType": "UPDATE",
      "Original": "update tbl1 set not_ref_col = 'foo' where id = 1",
      "Instructions": {
        "OperatorType": "Update",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "sharded_fk_allow",
          "Sharded": true
        },
        "TargetTabletType": "PRIMARY",
        "Query": "update tbl1 set not_ref_col = 'foo' where id = 1",
        "Table": "tbl1"
      },
      "TablesUsed": [
        "sharded_fk_allow.tbl1"
      ]
    }
  },
  {
    "comment": "Update in a table with column modified not shard-scoped foreign key whereas other column referencing same table is - disallowed",
    "query": "update tbl7 set t7col7 = 'foo', t7col72 = 42",
    "plan": "VT12002: unsupported: foreign keys management at vitess"
  },
  {
    "comment": "Update in a table with shard-scoped foreign keys with cascade disallowed",
    "query": "update tbl5 set t5col5 = 'foo'",
    "plan": "VT12002: unsupported: foreign keys management at vitess"
  },
  {
    "comment": "Insertion in a table with 2 foreign keys constraint with same table on different columns - both are not shard scoped - disallowed",
    "query": "insert into tbl6 (col6, t6col6) values (100, 'foo')",
    "plan": "VT12002: unsupported: cross-shard foreign keys"
  },
  {
    "comment": "Update a table with parent and child foreign keys - shard scoped",
    "query": "update tbl2 set col = 'foo'",
    "plan": {
      "QueryType": "UPDATE",
      "Original": "update tbl2 set col = 'foo'",
      "Instructions": {
        "OperatorType": "Update",
        "Variant": "Scatter",
        "Keyspace": {
          "Name": "sharded_fk_allow",
          "Sharded": true
        },
        "TargetTabletType": "PRIMARY",
        "Query": "update tbl2 set col = 'foo'",
        "Table": "tbl2"
      },
      "TablesUsed": [
        "sharded_fk_allow.tbl2"
      ]
    }
  },
  {
    "comment": "update table with column's parent foreign key cross shard - disallowed",
    "query": "update tbl10 set col = 'foo'",
    "plan": "VT12002: unsupported: foreign keys management at vitess"
  }
]
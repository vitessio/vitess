# Single table sharded scatter
"select col from user"
{
  "QueryType": "SELECT",
  "Original": "select col from user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select col from `user` where 1 != 1",
    "Query": "select col from `user`",
    "Table": "`user`"
  }
}
Gen4 plan same as above

# Single table unsharded
"select col from unsharded"
{
  "QueryType": "SELECT",
  "Original": "select col from unsharded",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select col from unsharded where 1 != 1",
    "Query": "select col from unsharded",
    "Table": "unsharded"
  }
}
Gen4 plan same as above

# Select from sequence
"select next 2 values from seq"
{
  "QueryType": "SELECT",
  "Original": "select next 2 values from seq",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectNext",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select next 2 values from seq where 1 != 1",
    "Query": "select next 2 values from seq",
    "Table": "seq"
  }
}
Gen4 plan same as above

# Select from reference
"select * from ref"
{
  "QueryType": "SELECT",
  "Original": "select * from ref",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectReference",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from ref where 1 != 1",
    "Query": "select * from ref",
    "Table": "ref"
  }
}
Gen4 plan same as above

# Single information_schema query
"select col from information_schema.foo"
{
  "QueryType": "SELECT",
  "Original": "select col from information_schema.foo",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select col from information_schema.foo where 1 != 1",
    "Query": "select col from information_schema.foo"
  }
}

# Multi-table unsharded
"select m1.col from unsharded as m1 join unsharded as m2"
{
  "QueryType": "SELECT",
  "Original": "select m1.col from unsharded as m1 join unsharded as m2",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select m1.col from unsharded as m1 join unsharded as m2 where 1 != 1",
    "Query": "select m1.col from unsharded as m1 join unsharded as m2",
    "Table": "unsharded"
  }
}

# Multi-table, multi-chunk
"select music.col from user join music"
{
  "QueryType": "SELECT",
  "Original": "select music.col from user join music",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "`user`_music",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from `user` where 1 != 1",
        "Query": "select 1 from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select music.col from music where 1 != 1",
        "Query": "select music.col from music",
        "Table": "music"
      }
    ]
  }
}
Gen4 plan same as above

# routing rules where table name matches, and there's no alias.
"select * from second_user.user"
{
  "QueryType": "SELECT",
  "Original": "select * from second_user.user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from `user` where 1 != 1",
    "Query": "select * from `user`",
    "Table": "`user`"
  }
}

# routing rules where table name matches, and there's an alias.
"select * from second_user.user as a"
{
  "QueryType": "SELECT",
  "Original": "select * from second_user.user as a",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from `user` as a where 1 != 1",
    "Query": "select * from `user` as a",
    "Table": "`user`"
  }
}

# routing rules where table name does not match, and there's no alias.
"select * from route1"
{
  "QueryType": "SELECT",
  "Original": "select * from route1",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from `user` as route1 where 1 != 1",
    "Query": "select * from `user` as route1",
    "Table": "`user`"
  }
}

# routing rules where table name does not match, and there's an alias.
"select * from route1 as a"
{
  "QueryType": "SELECT",
  "Original": "select * from route1 as a",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from `user` as a where 1 != 1",
    "Query": "select * from `user` as a",
    "Table": "`user`"
  }
}

# routing rules with master targeting
"select * from master_redirect"
{
  "QueryType": "SELECT",
  "Original": "select * from master_redirect",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select * from `user` as master_redirect where 1 != 1",
    "Query": "select * from `user` as master_redirect",
    "Table": "`user`"
  }
}

# routing rules bad table
"select * from bad_table"
"keyspace noks not found in vschema"
Gen4 plan same as above

# routing rules disabled table
"select * from disabled"
"table disabled has been disabled"
Gen4 plan same as above

# ',' join
"select music.col from user, music"
{
  "QueryType": "SELECT",
  "Original": "select music.col from user, music",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "`user`_music",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from `user` where 1 != 1",
        "Query": "select 1 from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select music.col from music where 1 != 1",
        "Query": "select music.col from music",
        "Table": "music"
      }
    ]
  }
}
Gen4 plan same as above

# ',' join unsharded
"select u1.a, u2.a from unsharded u1, unsharded u2"
{
  "QueryType": "SELECT",
  "Original": "select u1.a, u2.a from unsharded u1, unsharded u2",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select u1.a, u2.a from unsharded as u1, unsharded as u2 where 1 != 1",
    "Query": "select u1.a, u2.a from unsharded as u1, unsharded as u2",
    "Table": "unsharded"
  }
}

# ',' join information_schema
"select a.id,b.id from information_schema.a as a, information_schema.b as b"
{
  "QueryType": "SELECT",
  "Original": "select a.id,b.id from information_schema.a as a, information_schema.b as b",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select a.id, b.id from information_schema.a as a, information_schema.b as b where 1 != 1",
    "Query": "select a.id, b.id from information_schema.a as a, information_schema.b as b"
  }
}

# ',' 3-way join unsharded
"select u1.a, u2.a from unsharded u1, unsharded u2, unsharded u3"
{
  "QueryType": "SELECT",
  "Original": "select u1.a, u2.a from unsharded u1, unsharded u2, unsharded u3",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select u1.a, u2.a from unsharded as u1, unsharded as u2, unsharded as u3 where 1 != 1",
    "Query": "select u1.a, u2.a from unsharded as u1, unsharded as u2, unsharded as u3",
    "Table": "unsharded"
  }
}

# Left join, single chunk
"select m1.col from unsharded as m1 left join unsharded as m2 on m1.a=m2.b"
{
  "QueryType": "SELECT",
  "Original": "select m1.col from unsharded as m1 left join unsharded as m2 on m1.a=m2.b",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select m1.col from unsharded as m1 left join unsharded as m2 on m1.a = m2.b where 1 != 1",
    "Query": "select m1.col from unsharded as m1 left join unsharded as m2 on m1.a = m2.b",
    "Table": "unsharded"
  }
}

# Left join, multi-chunk
"select u.col from user u left join unsharded m on u.a = m.b"
{
  "QueryType": "SELECT",
  "Original": "select u.col from user u left join unsharded m on u.a = m.b",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "LeftJoin",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select u.col, u.a from `user` as u where 1 != 1",
        "Query": "select u.col, u.a from `user` as u",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded as m where 1 != 1",
        "Query": "select 1 from unsharded as m where m.b = :u_a",
        "Table": "unsharded"
      }
    ]
  }
}

# Three-way left join
"select user.col from user left join unsharded as m1 on user.col = m1.co left join unsharded as m2 on m1.col = m2.col"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user left join unsharded as m1 on user.col = m1.co left join unsharded as m2 on m1.col = m2.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "LeftJoin",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_unsharded_unsharded",
    "Inputs": [
      {
        "OperatorType": "Join",
        "Variant": "LeftJoin",
        "JoinColumnIndexes": "-1,1",
        "TableName": "`user`_unsharded",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.col from `user` where 1 != 1",
            "Query": "select `user`.col from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectUnsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select m1.col from unsharded as m1 where 1 != 1",
            "Query": "select m1.col from unsharded as m1 where m1.co = :user_col",
            "Table": "unsharded"
          }
        ]
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded as m2 where 1 != 1",
        "Query": "select 1 from unsharded as m2 where m2.col = :m1_col",
        "Table": "unsharded"
      }
    ]
  }
}

# Three-way left join, right-associated
"select user.col from user left join user_extra as e left join unsharded as m1 on m1.col = e.col on user.col = e.col"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user left join user_extra as e left join unsharded as m1 on m1.col = e.col on user.col = e.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "LeftJoin",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Join",
        "Variant": "LeftJoin",
        "TableName": "user_extra_unsharded",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select e.col from user_extra as e where 1 != 1",
            "Query": "select e.col from user_extra as e where e.col = :user_col",
            "Table": "user_extra"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectUnsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select 1 from unsharded as m1 where 1 != 1",
            "Query": "select 1 from unsharded as m1 where m1.col = :e_col",
            "Table": "unsharded"
          }
        ]
      }
    ]
  }
}

# Right join
"select m1.col from unsharded as m1 right join unsharded as m2 on m1.a=m2.b"
{
  "QueryType": "SELECT",
  "Original": "select m1.col from unsharded as m1 right join unsharded as m2 on m1.a=m2.b",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select m1.col from unsharded as m2 left join unsharded as m1 on m1.a = m2.b where 1 != 1",
    "Query": "select m1.col from unsharded as m2 left join unsharded as m1 on m1.a = m2.b",
    "Table": "unsharded"
  }
}

# Right join with a join LHS
"select m1.col from unsharded as m1 join unsharded as m2 right join unsharded as m3 on m1.a=m2.b"
{
  "QueryType": "SELECT",
  "Original": "select m1.col from unsharded as m1 join unsharded as m2 right join unsharded as m3 on m1.a=m2.b",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select m1.col from unsharded as m3 left join (unsharded as m1 join unsharded as m2) on m1.a = m2.b where 1 != 1",
    "Query": "select m1.col from unsharded as m3 left join (unsharded as m1 join unsharded as m2) on m1.a = m2.b",
    "Table": "unsharded"
  }
}

# Straight-join
"select m1.col from unsharded as m1 straight_join unsharded as m2"
{
  "QueryType": "SELECT",
  "Original": "select m1.col from unsharded as m1 straight_join unsharded as m2",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select m1.col from unsharded as m1 straight_join unsharded as m2 where 1 != 1",
    "Query": "select m1.col from unsharded as m1 straight_join unsharded as m2",
    "Table": "unsharded"
  }
}

# Three-way join
"select user.col from user join unsharded as m1 join unsharded as m2"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join unsharded as m1 join unsharded as m2",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_unsharded_unsharded",
    "Inputs": [
      {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "-1",
        "TableName": "`user`_unsharded",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.col from `user` where 1 != 1",
            "Query": "select `user`.col from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectUnsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select 1 from unsharded as m1 where 1 != 1",
            "Query": "select 1 from unsharded as m1",
            "Table": "unsharded"
          }
        ]
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded as m2 where 1 != 1",
        "Query": "select 1 from unsharded as m2",
        "Table": "unsharded"
      }
    ]
  }
}

# Parenthesized, single chunk
"select user.col from user join (unsharded as m1 join unsharded as m2)"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join (unsharded as m1 join unsharded as m2)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from (unsharded as m1 join unsharded as m2) where 1 != 1",
        "Query": "select 1 from (unsharded as m1 join unsharded as m2)",
        "Table": "unsharded"
      }
    ]
  }
}

# Parenthesized, multi-chunk
"select user.col from user join (user as u1 join unsharded)"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join (user as u1 join unsharded)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_`user`_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Join",
        "Variant": "Join",
        "TableName": "`user`_unsharded",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from `user` as u1 where 1 != 1",
            "Query": "select 1 from `user` as u1",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectUnsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select 1 from unsharded where 1 != 1",
            "Query": "select 1 from unsharded",
            "Table": "unsharded"
          }
        ]
      }
    ]
  }
}

# index hints, make sure they are not stripped.
"select user.col from user use index(a)"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user use index(a)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` use index (a) where 1 != 1",
    "Query": "select `user`.col from `user` use index (a)",
    "Table": "`user`"
  }
}

# mergeable sharded join on unique vindex
"select user.col from user join user_extra on user.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on `user`.id = user_extra.user_id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on `user`.id = user_extra.user_id",
    "Table": "`user`"
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user`, user_extra where 1 != 1",
    "Query": "select `user`.col from `user`, user_extra where `user`.id = user_extra.user_id",
    "Table": "`user`, user_extra"
  }
}

# mergeable sharded join on unique vindex (parenthesized ON clause)
"select user.col from user join user_extra on (user.id = user_extra.user_id)"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on (user.id = user_extra.user_id)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on `user`.id = user_extra.user_id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on `user`.id = user_extra.user_id",
    "Table": "`user`"
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on (user.id = user_extra.user_id)",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user`, user_extra where 1 != 1",
    "Query": "select `user`.col from `user`, user_extra where `user`.id = user_extra.user_id",
    "Table": "`user`, user_extra"
  }
}

# mergeable sharded join on unique vindex, with a stray condition
"select user.col from user join user_extra on user.col between 1 and 2 and user.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.col between 1 and 2 and user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on `user`.col between 1 and 2 and `user`.id = user_extra.user_id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on `user`.col between 1 and 2 and `user`.id = user_extra.user_id",
    "Table": "`user`"
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.col between 1 and 2 and user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user`, user_extra where 1 != 1",
    "Query": "select `user`.col from `user`, user_extra where `user`.col between 1 and 2 and `user`.id = user_extra.user_id",
    "Table": "`user`, user_extra"
  }
}

# mergeable sharded join on unique vindex, swapped operands
"select user.col from user join user_extra on user_extra.user_id = user.id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user_extra.user_id = user.id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on user_extra.user_id = `user`.id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on user_extra.user_id = `user`.id",
    "Table": "`user`"
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user_extra.user_id = user.id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user`, user_extra where 1 != 1",
    "Query": "select `user`.col from `user`, user_extra where user_extra.user_id = `user`.id",
    "Table": "`user`, user_extra"
  }
}

# mergeable sharded join on unique vindex, and condition
"select user.col from user join user_extra on user.id = 5 and user.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = 5 and user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on `user`.id = 5 and `user`.id = user_extra.user_id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on `user`.id = 5 and `user`.id = user_extra.user_id",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = 5 and user.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user`, user_extra where 1 != 1",
    "Query": "select `user`.col from `user`, user_extra where `user`.id = 5 and `user`.id = user_extra.user_id",
    "Table": "`user`, user_extra",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# sharded join on unique vindex, inequality
"select user.col from user join user_extra on user.id < user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id \u003c user_extra.user_id",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col, `user`.id from `user` where 1 != 1",
        "Query": "select `user`.col, `user`.id from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra where :user_id \u003c user_extra.user_id",
        "Table": "user_extra"
      }
    ]
  }
}

# sharded join, non-col reference RHS
"select user.col from user join user_extra on user.id = 5"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = 5",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user` where `user`.id = 5",
        "Table": "`user`",
        "Values": [
          5
        ],
        "Vindex": "user_index"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra",
        "Table": "user_extra"
      }
    ]
  }
}
Gen4 plan same as above

# sharded join, non-col reference LHS
"select user.col from user join user_extra on 5 = user.id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on 5 = user.id",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user` where `user`.id = 5",
        "Table": "`user`",
        "Values": [
          5
        ],
        "Vindex": "user_index"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra",
        "Table": "user_extra"
      }
    ]
  }
}
Gen4 plan same as above

# sharded join, non-vindex col
"select user.col from user join user_extra on user.id = user_extra.col"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = user_extra.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col, `user`.id from `user` where 1 != 1",
        "Query": "select `user`.col, `user`.id from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra where user_extra.col = :user_id",
        "Table": "user_extra"
      }
    ]
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.id = user_extra.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "user_extra_`user`",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.col from user_extra where 1 != 1",
        "Query": "select user_extra.col from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user` where `user`.id = :user_extra_col",
        "Table": "`user`",
        "Values": [
          ":user_extra_col"
        ],
        "Vindex": "user_index"
      }
    ]
  }
}

# sharded join, non-unique vindex
"select user.col from user_extra join user on user_extra.user_id = user.name"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user_extra join user on user_extra.user_id = user.name",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "user_extra_`user`",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.user_id from user_extra where 1 != 1",
        "Query": "select user_extra.user_id from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqual",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col from `user` where 1 != 1",
        "Query": "select `user`.col from `user` where `user`.`name` = :user_extra_user_id",
        "Table": "`user`",
        "Values": [
          ":user_extra_user_id"
        ],
        "Vindex": "name_user_map"
      }
    ]
  }
}

# join with reference table
"select user.col from user join ref"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join ref",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join ref where 1 != 1",
    "Query": "select `user`.col from `user` join ref",
    "Table": "`user`"
  }
}

# reference table self-join
"select r1.col from ref r1 join ref"
{
  "QueryType": "SELECT",
  "Original": "select r1.col from ref r1 join ref",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectReference",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select r1.col from ref as r1 join ref where 1 != 1",
    "Query": "select r1.col from ref as r1 join ref",
    "Table": "ref"
  }
}

# reference table can merge with other opcodes left to right.
"select ref.col from ref join user"
{
  "QueryType": "SELECT",
  "Original": "select ref.col from ref join user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select ref.col from ref join `user` where 1 != 1",
    "Query": "select ref.col from ref join `user`",
    "Table": "`user`"
  }
}

# reference table can merge with other opcodes left to right and vindex value is in the plan.
# This tests that route.Merge also copies the condition to the LHS.
"select ref.col from ref join (select aa from user where user.id=1) user"
{
  "QueryType": "SELECT",
  "Original": "select ref.col from ref join (select aa from user where user.id=1) user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select ref.col from ref join (select aa from `user` where 1 != 1) as `user` where 1 != 1",
    "Query": "select ref.col from ref join (select aa from `user` where `user`.id = 1) as `user`",
    "Table": "`user`",
    "Values": [
      1
    ],
    "Vindex": "user_index"
  }
}

# routing rules for join, unsharded route wins if we can't find a merged route
"select route2.col from route2 join user_extra"
{
  "QueryType": "SELECT",
  "Original": "select route2.col from route2 join user_extra",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "unsharded_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select route2.col from unsharded as route2 where 1 != 1",
        "Query": "select route2.col from unsharded as route2",
        "Table": "unsharded"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra",
        "Table": "user_extra"
      }
    ]
  }
}

# subquery
"select id from (select id, col from user where id = 5) as t"
{
  "QueryType": "SELECT",
  "Original": "select id from (select id, col from user where id = 5) as t",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from (select id, col from `user` where 1 != 1) as t where 1 != 1",
    "Query": "select id from (select id, col from `user` where id = 5) as t",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# subquery with join
"select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select t.id from (select id from `user` where 1 != 1) as t join user_extra on t.id = user_extra.user_id where 1 != 1",
    "Query": "select t.id from (select id from `user` where id = 5) as t join user_extra on t.id = user_extra.user_id",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# subquery with join, and aliased references
"select t.id from (select user.id from user where user.id = 5) as t join user_extra on t.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select t.id from (select user.id from user where user.id = 5) as t join user_extra on t.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select t.id from (select `user`.id from `user` where 1 != 1) as t join user_extra on t.id = user_extra.user_id where 1 != 1",
    "Query": "select t.id from (select `user`.id from `user` where `user`.id = 5) as t join user_extra on t.id = user_extra.user_id",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# subquery with join, duplicate columns
"select t.id from (select user.id, id from user where user.id = 5) as t join user_extra on t.id = user_extra.user_id"
"duplicate column aliases: id"

# subquery in RHS of join
"select t.id from user_extra join (select id from user where id = 5) as t on t.id = user_extra.user_id"
{
  "QueryType": "SELECT",
  "Original": "select t.id from user_extra join (select id from user where id = 5) as t on t.id = user_extra.user_id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select t.id from user_extra join (select id from `user` where 1 != 1) as t on t.id = user_extra.user_id where 1 != 1",
    "Query": "select t.id from user_extra join (select id from `user` where id = 5) as t on t.id = user_extra.user_id",
    "Table": "user_extra"
  }
}

# subquery in FROM with cross-shard join
"select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.col"
{
  "QueryType": "SELECT",
  "Original": "select t.id from (select id from user where id = 5) as t join user_extra on t.id = user_extra.col",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select t.id from (select id from `user` where 1 != 1) as t where 1 != 1",
        "Query": "select t.id from (select id from `user` where id = 5) as t",
        "Table": "`user`",
        "Values": [
          5
        ],
        "Vindex": "user_index"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra where user_extra.col = :t_id",
        "Table": "user_extra"
      }
    ]
  }
}

# routing rules for subquery
"select id from (select id, col from route1 where id = 5) as t"
{
  "QueryType": "SELECT",
  "Original": "select id from (select id, col from route1 where id = 5) as t",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from (select id, col from `user` as route1 where 1 != 1) as t where 1 != 1",
    "Query": "select id from (select id, col from `user` as route1 where id = 5) as t",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# routing rules for subquery where the constraint is in the outer query
"select id from (select id, col from route1) as t where id = 5"
{
  "QueryType": "SELECT",
  "Original": "select id from (select id, col from route1) as t where id = 5",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select id from (select id, col from `user` as route1 where 1 != 1) as t where 1 != 1",
    "Query": "select id from (select id, col from `user` as route1) as t where id = 5",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# merge subqueries with single-shard routes
"select u.col, e.col from (select col from user where id = 5) as u join (select col from user_extra where user_id = 5) as e"
{
  "QueryType": "SELECT",
  "Original": "select u.col, e.col from (select col from user where id = 5) as u join (select col from user_extra where user_id = 5) as e",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectEqualUnique",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select u.col, e.col from (select col from `user` where 1 != 1) as u join (select col from user_extra where 1 != 1) as e where 1 != 1",
    "Query": "select u.col, e.col from (select col from `user` where id = 5) as u join (select col from user_extra where user_id = 5) as e",
    "Table": "`user`",
    "Values": [
      5
    ],
    "Vindex": "user_index"
  }
}

# access to unqualified column names in information_schema
"select * from information_schema.a where b=10"
{
  "QueryType": "SELECT",
  "Original": "select * from information_schema.a where b=10",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from information_schema.a where 1 != 1",
    "Query": "select * from information_schema.a where b = 10"
  }
}

# access to qualified column names in information_schema
"select * from information_schema.a where information_schema.a.b=10"
{
  "QueryType": "SELECT",
  "Original": "select * from information_schema.a where information_schema.a.b=10",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from information_schema.a where 1 != 1",
    "Query": "select * from information_schema.a where information_schema.a.b = 10"
  }
}

# join of information_schema with normal table
"select unsharded.foo from information_schema.a join unsharded"
{
  "QueryType": "SELECT",
  "Original": "select unsharded.foo from information_schema.a join unsharded",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from information_schema.a where 1 != 1",
        "Query": "select 1 from information_schema.a"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded.foo from unsharded where 1 != 1",
        "Query": "select unsharded.foo from unsharded",
        "Table": "unsharded"
      }
    ]
  }
}

# join of normal table with information_schema
"select unsharded.foo from unsharded join information_schema.a"
{
  "QueryType": "SELECT",
  "Original": "select unsharded.foo from unsharded join information_schema.a",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "unsharded_",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded.foo from unsharded where 1 != 1",
        "Query": "select unsharded.foo from unsharded",
        "Table": "unsharded"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from information_schema.a where 1 != 1",
        "Query": "select 1 from information_schema.a"
      }
    ]
  }
}

# wire-up on join with cross-shard subquery
"select t.col1 from (select user.id, user.col1 from user join user_extra) as t join unsharded on unsharded.col1 = t.col1 and unsharded.id = t.id"
{
  "QueryType": "SELECT",
  "Original": "select t.col1 from (select user.id, user.col1 from user join user_extra) as t join unsharded on unsharded.col1 = t.col1 and unsharded.id = t.id",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra_unsharded",
    "Inputs": [
      {
        "OperatorType": "Subquery",
        "Columns": [
          1,
          0
        ],
        "Inputs": [
          {
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "-1,-2",
            "TableName": "`user`_user_extra",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "SelectScatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select `user`.id, `user`.col1 from `user` where 1 != 1",
                "Query": "select `user`.id, `user`.col1 from `user`",
                "Table": "`user`"
              },
              {
                "OperatorType": "Route",
                "Variant": "SelectScatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from user_extra where 1 != 1",
                "Query": "select 1 from user_extra",
                "Table": "user_extra"
              }
            ]
          }
        ]
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded where 1 != 1",
        "Query": "select 1 from unsharded where unsharded.col1 = :t_col1 and unsharded.id = :t_id",
        "Table": "unsharded"
      }
    ]
  }
}

# wire-up on within cross-shard subquery
"select t.id from (select user.id, user.col1 from user join user_extra on user_extra.col = user.col) as t"
{
  "QueryType": "SELECT",
  "Original": "select t.id from (select user.id, user.col1 from user join user_extra on user_extra.col = user.col) as t",
  "Instructions": {
    "OperatorType": "Subquery",
    "Columns": [
      0
    ],
    "Inputs": [
      {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "-1,-2",
        "TableName": "`user`_user_extra",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.id, `user`.col1, `user`.col from `user` where 1 != 1",
            "Query": "select `user`.id, `user`.col1, `user`.col from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from user_extra where 1 != 1",
            "Query": "select 1 from user_extra where user_extra.col = :user_col",
            "Table": "user_extra"
          }
        ]
      }
    ]
  }
}

# Join with cross-shard subquery on rhs
"select t.col1 from unsharded_a ua join (select user.id, user.col1 from user join user_extra) as t"
{
  "QueryType": "SELECT",
  "Original": "select t.col1 from unsharded_a ua join (select user.id, user.col1 from user join user_extra) as t",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "unsharded_a_`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded_a as ua where 1 != 1",
        "Query": "select 1 from unsharded_a as ua",
        "Table": "unsharded_a"
      },
      {
        "OperatorType": "Subquery",
        "Columns": [
          1
        ],
        "Inputs": [
          {
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "-1,-2",
            "TableName": "`user`_user_extra",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "SelectScatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select `user`.id, `user`.col1 from `user` where 1 != 1",
                "Query": "select `user`.id, `user`.col1 from `user`",
                "Table": "`user`"
              },
              {
                "OperatorType": "Route",
                "Variant": "SelectScatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from user_extra where 1 != 1",
                "Query": "select 1 from user_extra",
                "Table": "user_extra"
              }
            ]
          }
        ]
      }
    ]
  }
}

# subquery in ON clause, single route
"select unsharded_a.col from unsharded_a join unsharded_b on (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select unsharded_a.col from unsharded_a join unsharded_b on (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutValue",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from `user` where 1 != 1",
        "Query": "select col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded_a.col from unsharded_a join unsharded_b on :__sq1 where 1 != 1",
        "Query": "select unsharded_a.col from unsharded_a join unsharded_b on :__sq1",
        "Table": "unsharded_a"
      }
    ]
  }
}

# subquery in ON clause as sub-expression
"select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col+(select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col+(select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutValue",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from `user` where 1 != 1",
        "Query": "select col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col + :__sq1 where 1 != 1",
        "Query": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col + :__sq1",
        "Table": "unsharded_a"
      }
    ]
  }
}

# IN subquery in ON clause, single route
"select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col in (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select unsharded_a.col from unsharded_a join unsharded_b on unsharded_a.col in (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutIn",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from `user` where 1 != 1",
        "Query": "select col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded_a.col from unsharded_a join unsharded_b on :__sq_has_values1 = 1 and unsharded_a.col in ::__sq1 where 1 != 1",
        "Query": "select unsharded_a.col from unsharded_a join unsharded_b on :__sq_has_values1 = 1 and unsharded_a.col in ::__sq1",
        "Table": "unsharded_a"
      }
    ]
  }
}

# subquery in ON clause, with join primitives
"select unsharded.col from unsharded join user on user.col in (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select unsharded.col from unsharded join user on user.col in (select col from user)",
  "Instructions": {
    "OperatorType": "Subquery",
    "Variant": "PulloutIn",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select col from `user` where 1 != 1",
        "Query": "select col from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "-1",
        "TableName": "unsharded_`user`",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectUnsharded",
            "Keyspace": {
              "Name": "main",
              "Sharded": false
            },
            "FieldQuery": "select unsharded.col from unsharded where 1 != 1",
            "Query": "select unsharded.col from unsharded",
            "Table": "unsharded"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from `user` where 1 != 1",
            "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
            "Table": "`user`"
          }
        ]
      }
    ]
  }
}

# subquery in ON clause, with left join primitives
# The subquery is not pulled all the way out.
"select unsharded.col from unsharded left join user on user.col in (select col from user)"
{
  "QueryType": "SELECT",
  "Original": "select unsharded.col from unsharded left join user on user.col in (select col from user)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "LeftJoin",
    "JoinColumnIndexes": "-1",
    "TableName": "unsharded_`user`",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded.col from unsharded where 1 != 1",
        "Query": "select unsharded.col from unsharded",
        "Table": "unsharded"
      },
      {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from `user` where 1 != 1",
            "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
            "Table": "`user`"
          }
        ]
      }
    ]
  }
}

# subquery in ON clause, with join primitives, and join on top
# The subquery is not pulled all the way out.
"select unsharded.col from unsharded join user on user.col in (select col from user) join unsharded_a"
{
  "QueryType": "SELECT",
  "Original": "select unsharded.col from unsharded join user on user.col in (select col from user) join unsharded_a",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "unsharded_`user`_unsharded_a",
    "Inputs": [
      {
        "OperatorType": "Subquery",
        "Variant": "PulloutIn",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select col from `user` where 1 != 1",
            "Query": "select col from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Join",
            "Variant": "Join",
            "JoinColumnIndexes": "-1",
            "TableName": "unsharded_`user`",
            "Inputs": [
              {
                "OperatorType": "Route",
                "Variant": "SelectUnsharded",
                "Keyspace": {
                  "Name": "main",
                  "Sharded": false
                },
                "FieldQuery": "select unsharded.col from unsharded where 1 != 1",
                "Query": "select unsharded.col from unsharded",
                "Table": "unsharded"
              },
              {
                "OperatorType": "Route",
                "Variant": "SelectScatter",
                "Keyspace": {
                  "Name": "user",
                  "Sharded": true
                },
                "FieldQuery": "select 1 from `user` where 1 != 1",
                "Query": "select 1 from `user` where :__sq_has_values1 = 1 and `user`.col in ::__sq1",
                "Table": "`user`"
              }
            ]
          }
        ]
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from unsharded_a where 1 != 1",
        "Query": "select 1 from unsharded_a",
        "Table": "unsharded_a"
      }
    ]
  }
}

# keyspace-qualified queries
"select user.user.col1, main.unsharded.col1 from user.user join main.unsharded where main.unsharded.col2 = user.user.col2"
{
  "QueryType": "SELECT",
  "Original": "select user.user.col1, main.unsharded.col1 from user.user join main.unsharded where main.unsharded.col2 = user.user.col2",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1,1",
    "TableName": "`user`_unsharded",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.col1, `user`.col2 from `user` where 1 != 1",
        "Query": "select `user`.col1, `user`.col2 from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectUnsharded",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select unsharded.col1 from unsharded where 1 != 1",
        "Query": "select unsharded.col1 from unsharded where unsharded.col2 = :user_col2",
        "Table": "unsharded"
      }
    ]
  }
}

# implicit table reference for unsharded keyspace
"select main.foo.col from main.foo"
{
  "QueryType": "SELECT",
  "Original": "select main.foo.col from main.foo",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select foo.col from foo where 1 != 1",
    "Query": "select foo.col from foo",
    "Table": "foo"
  }
}

# col refs should be case-insensitive
"select user.col from user join user_extra on user.ID = user_extra.User_Id"
{
  "QueryType": "SELECT",
  "Original": "select user.col from user join user_extra on user.ID = user_extra.User_Id",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select `user`.col from `user` join user_extra on `user`.ID = user_extra.User_Id where 1 != 1",
    "Query": "select `user`.col from `user` join user_extra on `user`.ID = user_extra.User_Id",
    "Table": "`user`"
  }
}

# subquery with join primitive (FROM)
"select id, t.id from (select user.id from user join user_extra) as t"
{
  "QueryType": "SELECT",
  "Original": "select id, t.id from (select user.id from user join user_extra) as t",
  "Instructions": {
    "OperatorType": "Subquery",
    "Columns": [
      0,
      0
    ],
    "Inputs": [
      {
        "OperatorType": "Join",
        "Variant": "Join",
        "JoinColumnIndexes": "-1",
        "TableName": "`user`_user_extra",
        "Inputs": [
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select `user`.id from `user` where 1 != 1",
            "Query": "select `user`.id from `user`",
            "Table": "`user`"
          },
          {
            "OperatorType": "Route",
            "Variant": "SelectScatter",
            "Keyspace": {
              "Name": "user",
              "Sharded": true
            },
            "FieldQuery": "select 1 from user_extra where 1 != 1",
            "Query": "select 1 from user_extra",
            "Table": "user_extra"
          }
        ]
      }
    ]
  }
}

# database call in ON clause.
# The on clause is weird because the substitution must even for root expressions.
"select u1.a from unsharded u1 join unsharded u2 on database()"
{
  "QueryType": "SELECT",
  "Original": "select u1.a from unsharded u1 join unsharded u2 on database()",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select u1.a from unsharded as u1 join unsharded as u2 on database() where 1 != 1",
    "Query": "select u1.a from unsharded as u1 join unsharded as u2 on database()",
    "Table": "unsharded"
  }
}

# last_insert_id for dual
"select last_insert_id()"
{
  "QueryType": "SELECT",
  "Original": "select last_insert_id()",
  "Instructions": {
    "OperatorType": "Projection",
    "Columns": [
      "last_insert_id()"
    ],
    "Expressions": [
      ":__lastInsertId"
    ],
    "Inputs": [
      {
        "OperatorType": "SingleRow"
      }
    ]
  }
}

# last_insert_id for sharded keyspace
"select last_insert_id() from user"
{
  "QueryType": "SELECT",
  "Original": "select last_insert_id() from user",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectScatter",
    "Keyspace": {
      "Name": "user",
      "Sharded": true
    },
    "FieldQuery": "select :__lastInsertId as `last_insert_id()` from `user` where 1 != 1",
    "Query": "select :__lastInsertId as `last_insert_id()` from `user`",
    "Table": "`user`"
  }
}
Gen4 plan same as above

# last_insert_id for unsharded route
"select last_insert_id() from main.unsharded"
{
  "QueryType": "SELECT",
  "Original": "select last_insert_id() from main.unsharded",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectUnsharded",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select :__lastInsertId as `last_insert_id()` from unsharded where 1 != 1",
    "Query": "select :__lastInsertId as `last_insert_id()` from unsharded",
    "Table": "unsharded"
  }
}
Gen4 plan same as above

# join with USING construct
"select user.id from user join user_extra using(id)"
{
  "QueryType": "SELECT",
  "Original": "select user.id from user join user_extra using(id)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1",
    "TableName": "`user`_user_extra",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.id from `user` where 1 != 1",
        "Query": "select `user`.id from `user`",
        "Table": "`user`"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select 1 from user_extra where 1 != 1",
        "Query": "select 1 from user_extra where user_extra.id = :user_id",
        "Table": "user_extra"
      }
    ]
  }
}
{
  "QueryType": "SELECT",
  "Original": "select user.id from user join user_extra using(id)",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1",
    "TableName": "user_extra_`user`",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectScatter",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select user_extra.id from user_extra where 1 != 1",
        "Query": "select user_extra.id from user_extra",
        "Table": "user_extra"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectEqualUnique",
        "Keyspace": {
          "Name": "user",
          "Sharded": true
        },
        "FieldQuery": "select `user`.id from `user` where 1 != 1",
        "Query": "select `user`.id from `user` where `user`.id = :user_extra_id",
        "Table": "`user`",
        "Values": [
          ":user_extra_id"
        ],
        "Vindex": "user_index"
      }
    ]
  }
}

# verify ',' vs JOIN precedence
"select u1.a from unsharded u1, unsharded u2 join unsharded u3 on u1.a = u2.a"
"symbol u1.a not found"

# first expression fails for ',' join (code coverage: ensure error is returned)
"select user.foo.col from user.foo, user"
"table foo not found"
Gen4 plan same as above

# table names should be case-sensitive
"select unsharded.id from unsharded where Unsharded.val = 1"
"symbol Unsharded.val not found"

# implicit table reference for sharded keyspace
"select user.foo.col from user.foo"
"table foo not found"
Gen4 plan same as above

# duplicate symbols
"select user.id from user join user"
"duplicate symbol: `user`"

# duplicate symbols for merging routes
"select user.id from user join user_extra user on user.id = user.user_id"
"duplicate symbol: `user`"

# non-existent table
"select c from t"
"table t not found"
Gen4 plan same as above

# non-existent table on left of join
"select c from t join user"
"table t not found"

# non-existent table on right of join
"select c from user join t"
"table t not found"

# information schema query that uses table_schema
"select column_name from information_schema.columns where table_schema = (select schema())"
{
  "QueryType": "SELECT",
  "Original": "select column_name from information_schema.columns where table_schema = (select schema())",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select column_name from information_schema.`columns` where 1 != 1",
    "Query": "select column_name from information_schema.`columns` where table_schema = schema()"
  }
}

# information schema join
"select * from information_schema.a join information_schema.b"
{
  "QueryType": "SELECT",
  "Original": "select * from information_schema.a join information_schema.b",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from information_schema.a join information_schema.b where 1 != 1",
    "Query": "select * from information_schema.a join information_schema.b"
  }
}

# rails query
"select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as name, rc.update_rule as on_update, rc.delete_rule as on_delete from information_schema.referential_constraints as rc join information_schema.key_column_usage as fk using (constraint_schema, constraint_name) where fk.referenced_column_name is not null and fk.table_schema = database() and fk.table_name = ':vtg1' and rc.constraint_schema = database() and rc.table_name = ':vtg1'"
{
  "QueryType": "SELECT",
  "Original": "select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as name, rc.update_rule as on_update, rc.delete_rule as on_delete from information_schema.referential_constraints as rc join information_schema.key_column_usage as fk using (constraint_schema, constraint_name) where fk.referenced_column_name is not null and fk.table_schema = database() and fk.table_name = ':vtg1' and rc.constraint_schema = database() and rc.table_name = ':vtg1'",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1,2,3,4,-1,-2",
    "TableName": "_",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select rc.update_rule as on_update, rc.delete_rule as on_delete, rc.constraint_schema, rc.constraint_name from information_schema.referential_constraints as rc where 1 != 1",
        "Query": "select rc.update_rule as on_update, rc.delete_rule as on_delete, rc.constraint_schema, rc.constraint_name from information_schema.referential_constraints as rc where rc.constraint_schema = database() and rc.table_name = :__vttablename",
        "SysTableTableName": "VARBINARY(\":vtg1\")"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as `name` from information_schema.key_column_usage as fk where 1 != 1",
        "Query": "select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as `name` from information_schema.key_column_usage as fk where fk.constraint_schema = :rc_constraint_schema and fk.constraint_name = :rc_constraint_name and fk.referenced_column_name is not null and fk.table_schema = database() and fk.table_name = :__vttablename",
        "SysTableTableName": "VARBINARY(\":vtg1\")"
      }
    ]
  }
}

#rails_query 2
"SELECT * FROM information_schema.schemata WHERE schema_name = 'user'"
{
  "QueryType": "SELECT",
  "Original": "SELECT * FROM information_schema.schemata WHERE schema_name = 'user'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select * from information_schema.schemata where 1 != 1",
    "Query": "select * from information_schema.schemata where schema_name = :__vtschemaname",
    "SysTableTableSchema": "VARBINARY(\"user\")"
  }
}

#rails_query 3
"SELECT table_comment FROM information_schema.tables WHERE table_schema = 'schema_name' AND table_name = 'table_name'"
{
  "QueryType": "SELECT",
  "Original": "SELECT table_comment FROM information_schema.tables WHERE table_schema = 'schema_name' AND table_name = 'table_name'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select table_comment from information_schema.`tables` where 1 != 1",
    "Query": "select table_comment from information_schema.`tables` where table_schema = :__vtschemaname and table_name = :__vttablename",
    "SysTableTableName": "VARBINARY(\"table_name\")",
    "SysTableTableSchema": "VARBINARY(\"schema_name\")"
  }
}

#rails_query 4
"SELECT fk.referenced_table_name AS 'to_table', fk.referenced_column_name AS 'primary_key',fk.column_name AS 'column',fk.constraint_name AS 'name',rc.update_rule AS 'on_update',rc.delete_rule AS 'on_delete' FROM information_schema.referential_constraints rc JOIN information_schema.key_column_usage fk USING (constraint_schema, constraint_name) WHERE fk.referenced_column_name IS NOT NULL AND fk.table_schema = 'table_schema' AND fk.table_name = 'table_name' AND rc.constraint_schema = 'table_schema' AND rc.table_name = 'table_name'"
{
  "QueryType": "SELECT",
  "Original": "SELECT fk.referenced_table_name AS 'to_table', fk.referenced_column_name AS 'primary_key',fk.column_name AS 'column',fk.constraint_name AS 'name',rc.update_rule AS 'on_update',rc.delete_rule AS 'on_delete' FROM information_schema.referential_constraints rc JOIN information_schema.key_column_usage fk USING (constraint_schema, constraint_name) WHERE fk.referenced_column_name IS NOT NULL AND fk.table_schema = 'table_schema' AND fk.table_name = 'table_name' AND rc.constraint_schema = 'table_schema' AND rc.table_name = 'table_name'",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "1,2,3,4,-1,-2",
    "TableName": "_",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select rc.update_rule as on_update, rc.delete_rule as on_delete, rc.constraint_schema, rc.constraint_name from information_schema.referential_constraints as rc where 1 != 1",
        "Query": "select rc.update_rule as on_update, rc.delete_rule as on_delete, rc.constraint_schema, rc.constraint_name from information_schema.referential_constraints as rc where rc.constraint_schema = :__vtschemaname and rc.table_name = :__vttablename",
        "SysTableTableName": "VARBINARY(\"table_name\")",
        "SysTableTableSchema": "VARBINARY(\"table_schema\")"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as `name` from information_schema.key_column_usage as fk where 1 != 1",
        "Query": "select fk.referenced_table_name as to_table, fk.referenced_column_name as primary_key, fk.column_name as `column`, fk.constraint_name as `name` from information_schema.key_column_usage as fk where fk.constraint_schema = :rc_constraint_schema and fk.constraint_name = :rc_constraint_name and fk.referenced_column_name is not null and fk.table_schema = :__vtschemaname and fk.table_name = :__vttablename",
        "SysTableTableName": "VARBINARY(\"table_name\")",
        "SysTableTableSchema": "VARBINARY(\"table_schema\")"
      }
    ]
  }
}

#rails_query 5
"SELECT cc.constraint_name AS 'name', cc.check_clause AS 'expression' FROM information_schema.check_constraints cc JOIN information_schema.table_constraints tc USING (constraint_schema, constraint_name) WHERE tc.table_schema = 'table_schema' AND tc.table_name = 'table_name' AND cc.constraint_schema = 'constraint_schema'"
{
  "QueryType": "SELECT",
  "Original": "SELECT cc.constraint_name AS 'name', cc.check_clause AS 'expression' FROM information_schema.check_constraints cc JOIN information_schema.table_constraints tc USING (constraint_schema, constraint_name) WHERE tc.table_schema = 'table_schema' AND tc.table_name = 'table_name' AND cc.constraint_schema = 'constraint_schema'",
  "Instructions": {
    "OperatorType": "Join",
    "Variant": "Join",
    "JoinColumnIndexes": "-1,-2",
    "TableName": "_",
    "Inputs": [
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select cc.constraint_name as `name`, cc.check_clause as expression, cc.constraint_schema from information_schema.check_constraints as cc where 1 != 1",
        "Query": "select cc.constraint_name as `name`, cc.check_clause as expression, cc.constraint_schema from information_schema.check_constraints as cc where cc.constraint_schema = :__vtschemaname",
        "SysTableTableSchema": "VARBINARY(\"constraint_schema\")"
      },
      {
        "OperatorType": "Route",
        "Variant": "SelectDBA",
        "Keyspace": {
          "Name": "main",
          "Sharded": false
        },
        "FieldQuery": "select 1 from information_schema.table_constraints as tc where 1 != 1",
        "Query": "select 1 from information_schema.table_constraints as tc where tc.constraint_schema = :cc_constraint_schema and tc.constraint_name = :cc_constraint_name and tc.table_schema = :__vtschemaname and tc.table_name = :__vttablename",
        "SysTableTableName": "VARBINARY(\"table_name\")",
        "SysTableTableSchema": "VARBINARY(\"table_schema\")"
      }
    ]
  }
}

#rails_query 6
"SELECT column_name FROM information_schema.statistics WHERE index_name = 'PRIMARY' AND table_schema = 'table_schema' AND table_name = 'table_name' ORDER BY seq_in_index"
{
  "QueryType": "SELECT",
  "Original": "SELECT column_name FROM information_schema.statistics WHERE index_name = 'PRIMARY' AND table_schema = 'table_schema' AND table_name = 'table_name' ORDER BY seq_in_index",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select column_name from information_schema.statistics where 1 != 1",
    "Query": "select column_name from information_schema.statistics where index_name = 'PRIMARY' and table_schema = :__vtschemaname and table_name = :__vttablename order by seq_in_index asc",
    "SysTableTableName": "VARBINARY(\"table_name\")",
    "SysTableTableSchema": "VARBINARY(\"table_schema\")"
  }
}

#rails_query 7
"SELECT generation_expression FROM information_schema.columns WHERE table_schema = 'table_schema' AND table_name = 'table_name' AND column_name = 'column_name'"
{
  "QueryType": "SELECT",
  "Original": "SELECT generation_expression FROM information_schema.columns WHERE table_schema = 'table_schema' AND table_name = 'table_name' AND column_name = 'column_name'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select generation_expression from information_schema.`columns` where 1 != 1",
    "Query": "select generation_expression from information_schema.`columns` where table_schema = :__vtschemaname and table_name = :__vttablename and column_name = 'column_name'",
    "SysTableTableName": "VARBINARY(\"table_name\")",
    "SysTableTableSchema": "VARBINARY(\"table_schema\")"
  }
}

#rails_query 8
"SELECT id FROM information_schema.processlist WHERE info LIKE '% FOR UPDATE'"
{
  "QueryType": "SELECT",
  "Original": "SELECT id FROM information_schema.processlist WHERE info LIKE '% FOR UPDATE'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select id from information_schema.`processlist` where 1 != 1",
    "Query": "select id from information_schema.`processlist` where info like '% FOR UPDATE'"
  }
}

#rails_query 9
"SELECT table_name FROM (SELECT * FROM information_schema.tables WHERE table_schema = 'table_schema') _subquery"
{
  "QueryType": "SELECT",
  "Original": "SELECT table_name FROM (SELECT * FROM information_schema.tables WHERE table_schema = 'table_schema') _subquery",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select table_name from (select * from information_schema.`tables` where 1 != 1) as _subquery where 1 != 1",
    "Query": "select table_name from (select * from information_schema.`tables` where table_schema = :__vtschemaname) as _subquery",
    "SysTableTableSchema": "VARBINARY(\"table_schema\")"
  }
}

#rails_query 10
"SELECT table_name FROM (SELECT * FROM information_schema.tables WHERE table_schema = 'table_schema') _subquery WHERE _subquery.table_type = 'table_type' AND _subquery.table_name = 'table_name'"
{
  "QueryType": "SELECT",
  "Original": "SELECT table_name FROM (SELECT * FROM information_schema.tables WHERE table_schema = 'table_schema') _subquery WHERE _subquery.table_type = 'table_type' AND _subquery.table_name = 'table_name'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select table_name from (select * from information_schema.`tables` where 1 != 1) as _subquery where 1 != 1",
    "Query": "select table_name from (select * from information_schema.`tables` where table_schema = :__vtschemaname) as _subquery where _subquery.table_type = 'table_type' and _subquery.table_name = :__vttablename",
    "SysTableTableName": "VARBINARY(\"table_name\")",
    "SysTableTableSchema": "VARBINARY(\"table_schema\")"
  }
}

# two predicates specifying the database for the same table work if the database is the same
"SELECT cc.constraint_name AS 'name' FROM information_schema.check_constraints cc  WHERE cc.constraint_schema = 'a' AND cc.table_schema = 'a'"
{
  "QueryType": "SELECT",
  "Original": "SELECT cc.constraint_name AS 'name' FROM information_schema.check_constraints cc  WHERE cc.constraint_schema = 'a' AND cc.table_schema = 'a'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select cc.constraint_name as `name` from information_schema.check_constraints as cc where 1 != 1",
    "Query": "select cc.constraint_name as `name` from information_schema.check_constraints as cc where cc.constraint_schema = :__vtschemaname and cc.table_schema = :__vtschemaname",
    "SysTableTableSchema": "VARBINARY(\"a\")"
  }
}

# system schema in where clause of information_schema query
"SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE table_schema = 'performance_schema' AND table_name = 'foo'"
{
  "QueryType": "SELECT",
  "Original": "SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE table_schema = 'performance_schema' AND table_name = 'foo'",
  "Instructions": {
    "OperatorType": "Route",
    "Variant": "SelectDBA",
    "Keyspace": {
      "Name": "main",
      "Sharded": false
    },
    "FieldQuery": "select COUNT(*) from INFORMATION_SCHEMA.`TABLES` where 1 != 1",
    "Query": "select COUNT(*) from INFORMATION_SCHEMA.`TABLES` where table_schema = :__vtschemaname and table_name = :__vttablename",
    "SysTableTableName": "VARBINARY(\"foo\")",
    "SysTableTableSchema": "VARBINARY(\"performance_schema\")"
  }
}

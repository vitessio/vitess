# Updates the website repository with generated error code documentation.
name: Update error code docs

on:
  workflow_run:
    workflows: ["Generate error code docs"]
    types: [completed]

permissions:
  contents: read
  actions: read

jobs:
  update_error_code_docs:
    name: Update error code docs
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Download artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: error-codes-*
          path: /tmp/artifact
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: true

      - name: Read metadata
        id: metadata
        run: |
          if [[ ! -f /tmp/artifact/metadata.json ]]; then
            echo "No metadata found, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "pr_number=$(jq -r '.pr_number' /tmp/artifact/metadata.json)" >> "$GITHUB_OUTPUT"
          echo "base_ref=$(jq -r '.base_ref' /tmp/artifact/metadata.json)" >> "$GITHUB_OUTPUT"

      - name: Generate GitHub App token
        if: steps.metadata.outputs.skip != 'true'
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: vitess,website
          permission-contents: write
          permission-pull-requests: write

      - name: Set token in environment
        if: steps.metadata.outputs.skip != 'true'
        env:
          TOKEN: ${{ steps.app-token.outputs.token }}
        run: echo "GH_TOKEN=$TOKEN" >> "$GITHUB_ENV"

      - name: Determine docs version
        if: steps.metadata.outputs.skip != 'true'
        id: docs_version
        env:
          BASE_REF: ${{ steps.metadata.outputs.base_ref }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          if [[ "$BASE_REF" == "main" ]]; then
            # Get the "next" version from website config.toml.
            VERSION=$(gh api "repos/${REPO_OWNER}/website/contents/config.toml" \
              --jq '.content' | base64 -d | grep 'next = ' | sed 's/.*"\([0-9.]*\)".*/\1/')
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Docs version (from next): $VERSION"
          elif [[ "$BASE_REF" =~ ^release-([0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Docs version (from release branch): $VERSION"
          else
            echo "Unknown base ref: $BASE_REF, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Clone website repository
        if: steps.metadata.outputs.skip != 'true' && steps.docs_version.outputs.skip != 'true'
        env:
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          git clone --depth 1 "https://github.com/${REPO_OWNER}/website.git" /tmp/website

      - name: Update error documentation
        if: steps.metadata.outputs.skip != 'true' && steps.docs_version.outputs.skip != 'true'
        id: update_docs
        env:
          VERSION: ${{ steps.docs_version.outputs.version }}
        run: |
          DOC_PATH="/tmp/website/content/en/docs/${VERSION}/reference/errors/query-serving.md"

          if [[ ! -f "$DOC_PATH" ]]; then
            echo "Documentation file not found: $DOC_PATH"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read the generated error codes.
          ERROR_CODES=$(cat /tmp/artifact/error_codes.txt)

          # Update the documentation between <!-- start --> and <!-- end --> markers.
          awk -v codes="$ERROR_CODES" '
            /<!-- start -->/ { print; print codes; skip=1; next }
            /<!-- end -->/ { skip=0 }
            !skip { print }
          ' "$DOC_PATH" > /tmp/query-serving-new.md

          mv /tmp/query-serving-new.md "$DOC_PATH"

          # Check if there are actual changes.
          cd /tmp/website
          if git diff --quiet; then
            echo "No changes detected in error code documentation"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "Changes detected in error code documentation"
            echo "doc_path=content/en/docs/${VERSION}/reference/errors/query-serving.md" >> "$GITHUB_OUTPUT"
          fi

      - name: Get GitHub App user ID
        if: steps.metadata.outputs.skip != 'true' && steps.docs_version.outputs.skip != 'true' && steps.update_docs.outputs.skip != 'true'
        id: get-user-id
        env:
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
        run: |
          echo "user-id=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        if: steps.metadata.outputs.skip != 'true' && steps.docs_version.outputs.skip != 'true' && steps.update_docs.outputs.skip != 'true'
        env:
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
          USER_ID: ${{ steps.get-user-id.outputs.user-id }}
        run: |
          git config --global user.name "${APP_SLUG}[bot]"
          git config --global user.email "${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"

      - name: Create or update PR on website
        if: steps.metadata.outputs.skip != 'true' && steps.docs_version.outputs.skip != 'true' && steps.update_docs.outputs.skip != 'true'
        env:
          PR_NUMBER: ${{ steps.metadata.outputs.pr_number }}
          DOC_PATH: ${{ steps.update_docs.outputs.doc_path }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPOSITORY: ${{ github.repository }}
        run: |
          BRANCH_NAME="update-error-code-${PR_NUMBER}"

          cd /tmp/website

          # Check if branch already exists.
          if gh api "repos/${REPO_OWNER}/website/branches/${BRANCH_NAME}" --silent 2>/dev/null; then
            echo "Branch ${BRANCH_NAME} already exists, updating..."
            git fetch origin "${BRANCH_NAME}"
            git checkout "${BRANCH_NAME}"
            git reset --hard origin/prod
          else
            echo "Creating new branch ${BRANCH_NAME}..."
            git checkout -b "${BRANCH_NAME}"
          fi

          # Stage and commit changes.
          git add "$DOC_PATH"
          git commit -m "Updated the query-serving error code"

          # Push changes.
          git push -f "https://x-access-token:${GH_TOKEN}@github.com/${REPO_OWNER}/website.git" "${BRANCH_NAME}"

          # Check if PR already exists.
          EXISTING_PR=$(gh pr list --repo "${REPO_OWNER}/website" --head "${BRANCH_NAME}" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR #${EXISTING_PR} already exists, updated branch"
            echo "https://github.com/${REPO_OWNER}/website/pull/${EXISTING_PR}"
          else
            # Create new PR.
            gh pr create \
              --repo "${REPO_OWNER}/website" \
              --title "Update error code documentation (#${PR_NUMBER})" \
              --body "## Description
          This Pull Request updates the error code documentation based on the changes made in https://github.com/${REPOSITORY}/pull/${PR_NUMBER}" \
              --base prod \
              --head "${BRANCH_NAME}"
          fi

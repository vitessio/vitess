run:
  go: 1.23
  timeout: 10m

linters-settings:
  depguard:
    rules:
      use_modern_packages:
        list-mode: lax
        deny:
          - pkg: "math/rand$"
            desc: Please use math/rand/v2
  errcheck:
    exclude-functions:
      - flag.Set
      - (*flag.FlagSet).Parse
      - (flag.Value).Set
      - fmt.Fprint
      - fmt.Fprintf
      - io.WriteString(fmt.State)
      - io.WriteString(net/http.ResponseWriter)
      - (net.Listener).Close
      - (net/http.ResponseWriter).Write
      - (*os.File).Close
      - os.Remove
      - os.RemoveAll
      - os.Rename
      - (*github.com/spf13/cobra.Command).Help
      - (*github.com/spf13/cobra.Command).MarkFlagRequired
      - (*github.com/spf13/cobra.Command).MarkPersistentFlagRequired
      - (*github.com/spf13/cobra.Command).MarkPersistentFlagFilename
      - (*github.com/spf13/pflag.FlagSet).MarkDeprecated
      - (*google.golang.org/grpc.ClientConn).Close
      - (*google.golang.org/grpc.Server).Serve
      - (*vitess.io/vitess/go/bytes2.Buffer).Write
      - (*vitess.io/vitess/go/bytes2.Buffer).WriteByte
      - (*vitess.io/vitess/go/bytes2.Buffer).WriteString
      - (vitess.io/vitess/go/sqltypes.BinWriter).Write
      - vitess.io/vitess/go/vt/orchestrator/external/golib/log.Errore
      - vitess.io/vitess/go/vt/orchestrator/external/golib/log.Errorf
      - vitess.io/vitess/go/vt/orchestrator/external/golib/log.Fatal
      - vitess.io/vitess/go/vt/orchestrator/external/golib/log.Fatale
      - vitess.io/vitess/go/vt/orchestrator/external/golib/log.Fatalf
      - (*vitess.io/vitess/go/vt/vttest.LocalCluster).TearDown

  goimports:
    local-prefixes: vitess.io/vitess
  govet:
    disable: # not supported when using Generics in 1.18
      - nilness
      - unusedwrite
      - loopclosure # fixed in go1.22

linters:
  disable-all: true
  enable:
    # Defaults
    - depguard
    - errcheck
    - govet
    - ineffassign
    - typecheck
    - staticcheck
    - gosimple

    # Extras
    - gofmt
    - goimports
    - bodyclose

    # revive is a replacement for golint, but we do not run it in CI for now.
    # This is only enabled as a post-commit hook
    # - revive

issues:
  exclude-rules:
    - path: '^go/vt/proto/'
      linters:
      - errcheck
      - goimports

    ### BEGIN: errcheck exclusion rules. Each rule should be considered
    #   a TODO for removal after adding error checks to that package/file/etc,
    #   except where otherwise noted.
    - path: '^go/cmd/(vtcombo|vtgateclienttest|vtorc)/'
      linters:
      - errcheck
    - path: '^go/mysql/'
      linters:
      - errcheck
    - path: '^go/mysql/collations'
      linters:
        - revive
    - path: '^go/pools/.*_test.go'
      linters:
      - errcheck
    - path: '^go/sqltypes/'
      linters:
      - errcheck
    - path: '^go/stats/statsd/'
      linters:
      - errcheck
    - path: '^go/test/'
      linters:
      - errcheck
    - path: '^go/vt/automation/'
      linters:
      - errcheck
    - path: '^go/vt/mysqlctl/'
      linters:
      - errcheck
    # (NB: @ajm188) Technically, the below `exclude-rules` for `go/vt/orchestrator/external` is
    # redundant with this line, but we actually want to permanently ignore orchestrator's
    # vendored code, so we are keeping the exclusion rules separate because this one
    # should be temporary while the latter should be permanent.
    - path: '^go/vt/orchestrator/'
      linters:
      - errcheck
    # This subtree should be permanently excluded, as it's vendored code.
    - path: '^go/vt/orchestrator/external/'
      linters:
      - errcheck
    - path: '^go/vt/schemamanager/'
      linters:
      - errcheck
    - path: '^go/vt/servenv/'
      linters:
      - errcheck
    # This code is autogenerated and should be permanently excluded.
    - path: '^go/vt/sqlparser/(ast_format|ast_format_fast).go'
      linters:
        - errcheck
    - path: '^go/vt/sqlparser/goyacc'
      linters:
      - errcheck
    - path: '^go/vt/throttler/.*_test.go'
      linters:
      - errcheck
    - path: '^go/vt/topo/.*/*._test.go'
      linters:
      - errcheck
    - path: '^go/vt/vtcombo/'
      linters:
      - errcheck
    - path: '^go/vt/vtctl/[^/]*.go'
      linters:
      - errcheck
    - path: '^go/vt/vtctl/grpcvtctlclient/'
      linters:
      - errcheck
    - path: '^go/vt/vtctl/grpcvtctlserver/'
      linters:
      - errcheck
    - path: '^go/vt/vtctld/(schema|.*_test).go'
      linters:
      - errcheck
    - path: '^go/vt/vtexplain/'
      linters:
      - errcheck
    - path: '^go/vt/vtgate/.*_test.go'
      linters:
      - errcheck
    - path: '^go/vt/vtgr/'
      linters:
      - errcheck
    - path: '^go/vt/vttablet/(customrule|filelogger|grpctmserver|onlineddl|sandboxconn|tabletserver)/'
      linters:
      - errcheck
    - path: '^go/vt/vttablet/tabletmanager/vreplication'
      linters:
      - errcheck
    - path: '^go/vt/vttablet/(.*endtoend.*|.*_test.go)'
      linters:
      - errcheck
    - path: '^go/vt/vttest'
      linters:
      - errcheck
    - path: '^go/vt/worker'
      linters:
      - errcheck
    - path: '^go/vt/workflow'
      linters:
      - errcheck
    - path: '^go/vt/wrangler'
      linters:
      - errcheck
    - path: '^go/vt/zkctl'
      linters:
      - errcheck
    ### END: errcheck exclusion rules

# https://github.com/golangci/golangci/wiki/Configuration
service:
  golangci-lint-version: 1.52.2 # use the fixed version to not introduce new linters unexpectedly
